{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Nudges","text":"<p>Nudges is a demo implementation of a paid SMS relay platform. It allows businesses (\"clients\") to send SMS announcements to their subscribers, with subscription management and payment processing via Stripe.</p> <p>This repository serves as a proof-of-concept demonstrating a modern, event-driven microservices architecture using .NET, GraphQL, Kafka, and React.</p> <p> View on GitHub</p>"},{"location":"#quick-start","title":"Quick Start","text":""},{"location":"#prerequisites","title":"Prerequisites","text":"<ul> <li>Docker and Docker Compose</li> <li>.NET SDK (for dev-certs)</li> <li>Stripe account (free)</li> <li>ngrok account (free)</li> <li>PowerShell</li> </ul>"},{"location":"#1-setup-ngrok","title":"1. Setup ngrok","text":"<p>Create <code>ngrok/ngrok.yml</code>:</p> <pre><code>version: \"2\"\nauthtoken: &lt;your_auth_token&gt;\n\ntunnels:\n  webhooks:\n    proto: http\n    addr: host.docker.internal:7071\n    domain: &lt;your_domain&gt;\n</code></pre>"},{"location":"#2-setup-stripe-webhooks","title":"2. Setup Stripe Webhooks","text":"<p>In Stripe Dashboard &gt; Developers &gt; Webhooks, add endpoint:</p> <ul> <li>URL: <code>https://&lt;your_domain&gt;/api/StripeWebhookHandler?code=&lt;your_api_key&gt;</code></li> <li>Events: <code>product.created</code></li> <li>Copy the Signing secret</li> </ul>"},{"location":"#3-configure-environment","title":"3. Configure Environment","text":"<p>Create <code>.env.external</code> at repo root:</p> <pre><code>STRIPE_API_KEY=&lt;your_stripe_api_key&gt;\nSTRIPE_WEBHOOKS_SECRET=&lt;your_signing_secret&gt;\nWEBHOOKS_API_KEY=&lt;your_api_key&gt;  # must match URL above\n\n# Optional (not needed for demo)\nTWILIO_ACCOUNT_SID=xxx\nTWILIO_AUTH_TOKEN=xxx\nTWILIO_MESSAGE_SERVICE_SID=xxx\n</code></pre>"},{"location":"#4-start-the-system","title":"4. Start the System","text":"<pre><code># Generate certificates\ndotnet dev-certs https -ep ./certs/aspnetapp.pfx\n./certs/generate-certs.ps1\n\n# Start all services\n./start-dev.ps1\n</code></pre> <p>First run takes ~20 minutes to build. Once ready, open <code>https://localhost:5050</code>.</p> <p>Login: <code>+15555555555</code> / <code>pass</code></p>"},{"location":"#architecture-overview","title":"Architecture Overview","text":"<pre><code>flowchart TB\n    subgraph Clients\n        Web[React UI]\n    end\n\n    subgraph Gateway\n        GQL[GraphQL Gateway]\n    end\n\n    subgraph APIs\n        UserApi\n        ProductApi\n        PaymentApi\n    end\n\n    subgraph Events\n        Kafka\n        KafkaConsumer[Kafka Consumers]\n    end\n\n    subgraph External\n        Stripe\n        Twilio\n    end\n\n    subgraph Data\n        PostgreSQL\n        Redis\n    end\n\n    Web --&gt; GQL\n    GQL --&gt; UserApi\n    GQL --&gt; ProductApi\n    GQL --&gt; PaymentApi\n\n    APIs --&gt; Kafka\n    Kafka --&gt; KafkaConsumer\n    KafkaConsumer --&gt; Stripe\n    KafkaConsumer --&gt; Twilio\n\n    Stripe --&gt; Webhooks\n    Twilio --&gt; Webhooks\n    Webhooks --&gt; Kafka\n\n    APIs --&gt; PostgreSQL\n    APIs --&gt; Redis</code></pre>"},{"location":"#how-it-works","title":"How It Works","text":"<p>When a user creates a plan in the UI:</p> <pre><code>sequenceDiagram\n    participant UI as React UI\n    participant Gateway as GraphQL Gateway\n    participant API as ProductApi\n    participant Kafka\n    participant Consumer as KafkaConsumer\n    participant Stripe\n    participant Webhooks\n\n    UI-&gt;&gt;Gateway: CreatePlan mutation\n    Gateway-&gt;&gt;API: createPlan\n    API-&gt;&gt;API: Save to DB\n    API-&gt;&gt;Kafka: PlanCreatedEvent\n    API--&gt;&gt;UI: Plan created\n\n    Kafka-&gt;&gt;Consumer: Consume event\n    Consumer-&gt;&gt;Stripe: Create Product\n    Stripe-&gt;&gt;Webhooks: product.created webhook\n    Webhooks-&gt;&gt;Kafka: ForeignProductSyncEvent\n    Kafka-&gt;&gt;Consumer: Consume sync event\n    Consumer-&gt;&gt;API: PatchPlan (add Stripe ID)\n    API--&gt;&gt;UI: onPlanUpdated subscription</code></pre>"},{"location":"#repository-structure","title":"Repository Structure","text":"Directory Contents <code>dotnet/</code> All .NET services and libraries <code>web/</code> React applications (admin UI, signup) <code>db/</code> Database scripts and migrations <code>terraform/</code> AWS infrastructure as code <code>mkdocs/</code> This documentation <code>.github/</code> CI/CD workflows"},{"location":"#key-technologies","title":"Key Technologies","text":"<ul> <li>Backend: .NET 10, ASP.NET Core, HotChocolate (GraphQL)</li> <li>Frontend: React, Relay, TypeScript</li> <li>Messaging: Apache Kafka</li> <li>Database: PostgreSQL, Redis</li> <li>Auth: Keycloak (OIDC/OAuth2)</li> <li>Payments: Stripe</li> <li>SMS: Twilio</li> <li>Infrastructure: AWS (ECS, RDS, ElastiCache), Terraform</li> </ul>"},{"location":"docker/","title":"Docker","text":"<p>The system runs entirely in Docker for local development. All services are defined in <code>docker-compose.yml</code>.</p>"},{"location":"docker/#quick-start","title":"Quick Start","text":"<pre><code># Generate certificates\ndotnet dev-certs https -ep ./certs/aspnetapp.pfx\n./certs/generate-certs.ps1\n\n# Start everything\n./start-dev.ps1\n</code></pre> <p>First run takes ~20 minutes to build. Once ready, open <code>https://localhost:5050</code>.</p>"},{"location":"docker/#services-overview","title":"Services Overview","text":""},{"location":"docker/#infrastructure","title":"Infrastructure","text":"Service Port Description <code>postgres</code> 5432 PostgreSQL database <code>redis</code> 6379 Redis cache <code>kafka</code> 9092, 29092 Kafka message broker <code>kafka-ui</code> 8080 Kafka management UI <code>keycloak</code> 8443 OIDC identity provider"},{"location":"docker/#observability","title":"Observability","text":"Service Port Description <code>grafana</code> 3000 Dashboards and visualization <code>prometheus</code> 9090 Metrics collection <code>tempo</code> 3200 Distributed tracing <code>loki</code> 3100 Log aggregation <code>otel-collector</code> 4317, 4318 OpenTelemetry collector"},{"location":"docker/#application-services","title":"Application Services","text":"Service Port Description <code>graphql-gateway</code> 5443 GraphQL federation gateway (HTTPS) <code>user-api</code> 5300 User/Client/Subscriber API <code>product-api</code> 5200 Plans/Pricing API <code>payment-api</code> 5400 Payments/Checkout API <code>auth-api</code> 5555 Authentication API (HTTPS) <code>webhooks</code> 7071 Stripe/Twilio webhook handler <code>warp-cache</code> 7777 gRPC caching service <code>localization-api</code> 8888 i18n string service <code>graph-monitor</code> 5145 GraphQL schema registry"},{"location":"docker/#kafka-consumers","title":"Kafka Consumers","text":"<p>All consumers use the same Docker image with different commands:</p> Container Topic Description <code>notifications-listener</code> Notifications SMS delivery <code>plans-listener</code> Plans Stripe product sync <code>price-tiers-listener</code> PriceTiers Stripe price sync <code>clients-listener</code> Clients Customer creation <code>payments-listener</code> Payments Payment processing <code>plan-subscription-listener</code> PlanSubscriptions Subscription lifecycle <code>user-authentication-listener</code> UserAuthentication Login events <code>foreign-products-listener</code> ForeignProducts External product sync"},{"location":"docker/#web-uis","title":"Web UIs","text":"Service Port Description <code>new-admin</code> 5050 Admin dashboard (HTTPS) <code>new-signup</code> 6060 Subscriber signup site (HTTPS)"},{"location":"docker/#external-service-proxies","title":"External Service Proxies","text":"Service Port Description <code>ngrok</code> 4040 Tunnel for webhooks <code>stripe-cli</code> - Forwards Stripe webhooks <code>payment-processor-proxy</code> 4243 Local Stripe API mock <code>maildev</code> 1080 Email testing UI"},{"location":"docker/#dockerfile-conventions","title":"Dockerfile Conventions","text":"<p>Dockerfiles live in the <code>dotnet/</code> directory, named after their service:</p> <pre><code>dotnet/\n\u251c\u2500\u2500 AuthApi.Dockerfile\n\u251c\u2500\u2500 AuthInit.Dockerfile\n\u251c\u2500\u2500 DbSeeder.Dockerfile\n\u251c\u2500\u2500 GraphMonitor.Dockerfile\n\u251c\u2500\u2500 GraphQLGateway.Dockerfile\n\u251c\u2500\u2500 KafkaConsumer.Dockerfile\n\u251c\u2500\u2500 LocalizationApi.Dockerfile\n\u251c\u2500\u2500 Migrator.Dockerfile\n\u251c\u2500\u2500 Nudges.Webhooks.Dockerfile\n\u251c\u2500\u2500 PaymentApi.Dockerfile\n\u251c\u2500\u2500 ProductApi.Dockerfile\n\u251c\u2500\u2500 UserApi.Dockerfile\n\u2514\u2500\u2500 WarpCache.Dockerfile\n</code></pre> <p>This placement allows Dockerfiles to reference shared projects without excessive <code>../</code> paths.</p>"},{"location":"docker/#environment-files","title":"Environment Files","text":"<p>Each service has its own <code>.env.docker</code> file:</p> <pre><code>dotnet/\n\u251c\u2500\u2500 AuthApi/.env.docker\n\u251c\u2500\u2500 ProductApi/.env.docker\n\u251c\u2500\u2500 UserApi/.env.docker\n\u251c\u2500\u2500 PaymentApi/.env.docker\n\u251c\u2500\u2500 KafkaConsumer/.env.docker\n\u251c\u2500\u2500 GraphQLGateway/GraphQLGateway/.env.docker\n\u2514\u2500\u2500 ...\n</code></pre> <p>Generate these with:</p> <pre><code>./configure.ps1 -Mode Docker\n</code></pre>"},{"location":"docker/#running-individual-services","title":"Running Individual Services","text":"<p>Start specific services:</p> <pre><code>docker compose up postgres redis kafka -d\ndocker compose up user-api product-api -d\n</code></pre> <p>Rebuild a single service:</p> <pre><code>docker compose build user-api\ndocker compose up user-api -d\n</code></pre> <p>View logs:</p> <pre><code>docker compose logs -f user-api\ndocker compose logs -f plans-listener\n</code></pre>"},{"location":"docker/#resource-limits","title":"Resource Limits","text":"<p>All services have memory limits defined:</p> Category Memory Infrastructure (Kafka, Postgres, Keycloak) 1GB APIs and Gateway 512MB Kafka Consumers 256MB Web UIs 256MB Utilities (ngrok, stripe-cli) 128MB"},{"location":"docker/#network","title":"Network","text":"<p>All services join the <code>Nudges</code> bridge network and communicate using container hostnames (e.g., <code>kafka:29092</code>, <code>postgres:5432</code>).</p> <p>Services that need to reach the host machine (for Keycloak) use:</p> <pre><code>extra_hosts:\n  - \"keycloak.local:host-gateway\"\n</code></pre>"},{"location":"docker/#volumes","title":"Volumes","text":"<p>Certificate mounts for HTTPS services:</p> <pre><code>volumes:\n  - ./certs/aspnetapp.pfx:/https/aspnetapp.pfx:ro\n  - ./certs/aspnetapp.crt:/etc/nginx/certs/aspnetapp.crt:ro\n  - ./certs/aspnetapp.key:/etc/nginx/certs/aspnetapp.key:ro\n</code></pre>"},{"location":"docker/#healthchecks","title":"Healthchecks","text":"<p>Critical services have healthchecks:</p> <ul> <li>Keycloak: TCP check on port 9000</li> <li>LocalizationApi: TCP check on port 8888</li> </ul> <p>Other services rely on Docker's restart policy.</p>"},{"location":"docker/#secrets","title":"Secrets","text":"<p>The <code>graph-monitor-headers</code> secret is used during API builds to register schemas:</p> <pre><code>secrets:\n  graph-monitor-headers:\n    file: ./dotnet/GraphMonitor/headers\n</code></pre>"},{"location":"getting-started/","title":"Getting Started","text":"<p>This guide walks you through setting up and running the Nudges system locally.</p>"},{"location":"getting-started/#prerequisites","title":"Prerequisites","text":"<ul> <li>Docker and Docker Compose</li> <li>.NET SDK (for dev-certs)</li> <li>Stripe account (free)</li> <li>ngrok account (free)</li> <li>PowerShell</li> </ul>"},{"location":"getting-started/#1-add-hosts-entry","title":"1. Add Hosts Entry","text":"<p>Keycloak requires a consistent hostname for OIDC token validation. Add this to your hosts file:</p> WindowsmacOS / Linux <p>Edit <code>C:\\Windows\\System32\\drivers\\etc\\hosts</code> as Administrator: <pre><code>127.0.0.1    keycloak.local\n</code></pre></p> <pre><code>sudo sh -c 'echo \"127.0.0.1    keycloak.local\" &gt;&gt; /etc/hosts'\n</code></pre>"},{"location":"getting-started/#2-setup-ngrok","title":"2. Setup ngrok","text":"<ol> <li>Create an ngrok account and follow their setup instructions</li> <li>Create <code>ngrok/ngrok.yml</code>:</li> </ol> <pre><code>version: \"2\"\nauthtoken: &lt;your_auth_token&gt;\n\ntunnels:\n  webhooks:\n    proto: http\n    addr: host.docker.internal:7071\n    domain: &lt;your_domain&gt;\n</code></pre> <p>Replace <code>&lt;your_auth_token&gt;</code> and <code>&lt;your_domain&gt;</code> with your ngrok credentials.</p>"},{"location":"getting-started/#3-setup-stripe-webhooks","title":"3. Setup Stripe Webhooks","text":"<ol> <li>In the Stripe Dashboard, go to Developers &gt; Webhooks</li> <li>Add a new endpoint:</li> <li>URL: <code>https://&lt;your_domain&gt;/api/StripeWebhookHandler?code=&lt;your_api_key&gt;</code></li> <li>Events: <code>product.created</code></li> <li>Copy the Signing secret (you'll need it below)</li> </ol>"},{"location":"getting-started/#4-configure-environment","title":"4. Configure Environment","text":"<p>Create <code>.env.external</code> at the repository root:</p> <pre><code>STRIPE_API_KEY=&lt;your_stripe_api_key&gt;\nSTRIPE_WEBHOOKS_SECRET=&lt;your_signing_secret&gt;\nWEBHOOKS_API_KEY=&lt;your_api_key&gt;  # must match the ?code= in webhook URL\n\n# Optional (not needed for demo)\nTWILIO_ACCOUNT_SID=xxx\nTWILIO_AUTH_TOKEN=xxx\nTWILIO_MESSAGE_SERVICE_SID=xxx\n</code></pre> Variable Source <code>STRIPE_API_KEY</code> Stripe Dashboard &gt; Developers &gt; API keys <code>STRIPE_WEBHOOKS_SECRET</code> Generated when creating the webhook endpoint <code>WEBHOOKS_API_KEY</code> Any value you choose (must match URL above)"},{"location":"getting-started/#5-generate-certificates","title":"5. Generate Certificates","text":"<pre><code># Create the PFX certificate\ndotnet dev-certs https -ep ./certs/aspnetapp.pfx\n\n# Generate PEM files for nginx\n./certs/generate-certs.ps1\n</code></pre>"},{"location":"getting-started/#6-start-the-system","title":"6. Start the System","text":"<pre><code>./start-dev.ps1\n</code></pre> <p>First run takes ~20 minutes to build all containers. Once ready, open <code>https://localhost:5050</code>.</p> <p>Login credentials:</p> <ul> <li>Username: <code>+15555555555</code></li> <li>Password: <code>pass</code></li> </ul> <p>If you see a \"View Plans\" button, the system is running.</p>"},{"location":"getting-started/#creating-your-first-plan","title":"Creating Your First Plan","text":"<ol> <li>Log in with the credentials above</li> <li>Click View Plans &gt; Create Plan</li> <li>Enter a Name and Max Messages (minimum required fields)</li> <li>Save changes</li> </ol> <p>If the \"Foreign Service ID\" field updates automatically, the full event-driven flow is working:</p> <pre><code>sequenceDiagram\n    participant UI as React UI\n    participant Gateway as GraphQL Gateway\n    participant API as ProductApi\n    participant Kafka\n    participant Consumer as KafkaConsumer\n    participant Stripe\n    participant Webhooks\n\n    UI-&gt;&gt;Gateway: CreatePlan mutation\n    Gateway-&gt;&gt;API: createPlan\n    API-&gt;&gt;API: Save to DB\n    API-&gt;&gt;Kafka: PlanCreatedEvent\n    API--&gt;&gt;UI: Plan created\n\n    Note over UI,Kafka: User has response, async flow continues\n\n    Kafka-&gt;&gt;Consumer: Consume event\n    Consumer-&gt;&gt;Stripe: Create Product\n    Stripe-&gt;&gt;Webhooks: product.created webhook\n    Webhooks-&gt;&gt;Kafka: ForeignProductSyncEvent\n    Kafka-&gt;&gt;Consumer: Consume sync event\n    Consumer-&gt;&gt;API: PatchPlan (add Stripe ID)\n    API--&gt;&gt;UI: onPlanUpdated subscription</code></pre>"},{"location":"getting-started/#troubleshooting","title":"Troubleshooting","text":""},{"location":"getting-started/#services-wont-start","title":"Services won't start","text":"<ul> <li>Check Docker is running</li> <li>Verify <code>.env.external</code> exists with valid values</li> <li>Check terminal output for specific errors</li> </ul>"},{"location":"getting-started/#foreign-service-id-doesnt-update","title":"Foreign Service ID doesn't update","text":"<ul> <li>Verify ngrok is running and tunnel is active</li> <li>Check Stripe webhook endpoint is configured correctly</li> <li>Ensure <code>WEBHOOKS_API_KEY</code> matches the <code>?code=</code> parameter in webhook URL</li> </ul>"},{"location":"getting-started/#certificate-errors","title":"Certificate errors","text":"<ul> <li>Re-run <code>dotnet dev-certs https -ep ./certs/aspnetapp.pfx</code></li> <li>Re-run <code>./certs/generate-certs.ps1</code></li> <li>Trust the dev certificate: <code>dotnet dev-certs https --trust</code></li> </ul>"},{"location":"infrastructure/","title":"Infrastructure Overview","text":"<p>Nudges is built as an event-driven microservices platform. This page provides a high-level view of how the components fit together.</p>"},{"location":"infrastructure/#system-architecture","title":"System Architecture","text":"<pre><code>flowchart TB\n    subgraph Internet\n        Users[Users/Browsers]\n        StripeExt[Stripe]\n        TwilioExt[Twilio]\n    end\n\n    subgraph AWS[\"AWS Cloud\"]\n        subgraph Public[\"Public Subnet\"]\n            ALB[Application Load Balancer]\n        end\n\n        subgraph Private[\"Private Subnet\"]\n            subgraph ECS[\"ECS Cluster\"]\n                subgraph Frontend\n                    AdminUI[Admin UI]\n                    SignupUI[Signup UI]\n                end\n\n                subgraph Gateway\n                    GQLGateway[GraphQL Gateway]\n                end\n\n                subgraph CoreAPIs[\"Core APIs\"]\n                    AuthAPI[AuthApi]\n                    UserAPI[UserApi]\n                    ProductAPI[ProductApi]\n                    PaymentAPI[PaymentApi]\n                end\n\n                subgraph Workers[\"Background Workers\"]\n                    KConsumers[Kafka Consumers]\n                    Webhooks[Webhooks Service]\n                end\n\n                subgraph Support[\"Support Services\"]\n                    WarpCache[WarpCache]\n                    GraphMon[GraphMonitor]\n                    LocalAPI[LocalizationApi]\n                end\n            end\n\n            subgraph Data[\"Data Layer\"]\n                RDS[(PostgreSQL RDS)]\n                ElastiCache[(ElastiCache Redis)]\n                MSK[Amazon MSK / Kafka]\n            end\n\n            Keycloak[Keycloak]\n        end\n    end\n\n    Users --&gt; ALB\n    ALB --&gt; AdminUI\n    ALB --&gt; SignupUI\n    ALB --&gt; GQLGateway\n    ALB --&gt; Webhooks\n\n    AdminUI --&gt; GQLGateway\n    SignupUI --&gt; GQLGateway\n\n    GQLGateway --&gt; AuthAPI\n    GQLGateway --&gt; UserAPI\n    GQLGateway --&gt; ProductAPI\n    GQLGateway --&gt; PaymentAPI\n    GQLGateway --&gt; WarpCache\n\n    CoreAPIs --&gt; RDS\n    CoreAPIs --&gt; ElastiCache\n    CoreAPIs --&gt; MSK\n    CoreAPIs --&gt; Keycloak\n\n    MSK --&gt; KConsumers\n    KConsumers --&gt; StripeExt\n    KConsumers --&gt; TwilioExt\n    KConsumers --&gt; CoreAPIs\n\n    StripeExt --&gt; Webhooks\n    TwilioExt --&gt; Webhooks\n    Webhooks --&gt; MSK\n\n    Workers --&gt; LocalAPI\n    Workers --&gt; WarpCache\n    Workers --&gt; GraphMon</code></pre>"},{"location":"infrastructure/#component-layers","title":"Component Layers","text":""},{"location":"infrastructure/#client-layer","title":"Client Layer","text":"Component Purpose Admin UI React app for clients to manage plans, view subscribers Signup UI React app for subscribers to sign up and manage subscriptions"},{"location":"infrastructure/#api-layer","title":"API Layer","text":"Component Purpose GraphQL Gateway Federation gateway composing all GraphQL subgraphs AuthApi OTP and OAuth authentication, token management UserApi User, client, and subscriber management ProductApi Plans, pricing tiers, subscriptions, discounts PaymentApi Stripe checkout sessions, payment confirmations"},{"location":"infrastructure/#event-layer","title":"Event Layer","text":"Component Purpose Kafka (MSK) Event streaming backbone KafkaConsumer Processes domain events, integrates with Stripe/Twilio Webhooks Receives external webhooks from Stripe and Twilio"},{"location":"infrastructure/#support-layer","title":"Support Layer","text":"Component Purpose WarpCache High-performance gRPC caching (tokens, sessions) GraphMonitor GraphQL schema/endpoint registry LocalizationApi String translation for SMS messages Keycloak Identity provider (OIDC/OAuth2)"},{"location":"infrastructure/#data-layer","title":"Data Layer","text":"Component Purpose PostgreSQL (RDS) Primary data store (userdb, productdb, paymentdb) Redis (ElastiCache) Caching, GraphQL subscriptions"},{"location":"infrastructure/#data-flow-patterns","title":"Data Flow Patterns","text":""},{"location":"infrastructure/#authentication-flow","title":"Authentication Flow","text":"<pre><code>sequenceDiagram\n    participant User\n    participant UI\n    participant AuthApi\n    participant Keycloak\n    participant WarpCache\n\n    User-&gt;&gt;UI: Enter phone number\n    UI-&gt;&gt;AuthApi: POST /otp\n    AuthApi-&gt;&gt;WarpCache: Store OTP secret\n    AuthApi--&gt;&gt;User: SMS with code\n\n    User-&gt;&gt;UI: Enter OTP code\n    UI-&gt;&gt;AuthApi: POST /otp/verify\n    AuthApi-&gt;&gt;Keycloak: Create/authenticate user\n    AuthApi-&gt;&gt;WarpCache: Store JWT token\n    AuthApi--&gt;&gt;UI: TokenId cookie</code></pre>"},{"location":"infrastructure/#event-driven-integration","title":"Event-Driven Integration","text":"<pre><code>sequenceDiagram\n    participant API as ProductApi\n    participant Kafka\n    participant Consumer as KafkaConsumer\n    participant Stripe\n    participant Webhooks\n\n    API-&gt;&gt;Kafka: PlanCreatedEvent\n    Kafka-&gt;&gt;Consumer: Consume\n    Consumer-&gt;&gt;Stripe: Create Product\n\n    Stripe-&gt;&gt;Webhooks: product.created webhook\n    Webhooks-&gt;&gt;Kafka: ForeignProductSyncEvent\n    Kafka-&gt;&gt;Consumer: Consume\n    Consumer-&gt;&gt;API: Update plan with Stripe ID</code></pre>"},{"location":"infrastructure/#sms-announcement-flow","title":"SMS Announcement Flow","text":"<pre><code>sequenceDiagram\n    participant Client\n    participant Twilio\n    participant Webhooks\n    participant Consumer as KafkaConsumer\n    participant LocalAPI as LocalizationApi\n\n    Client-&gt;&gt;Twilio: Send SMS \"Hello subscribers\"\n    Twilio-&gt;&gt;Webhooks: Incoming message webhook\n    Webhooks--&gt;&gt;Client: \"Reply CONFIRM to send\"\n\n    Client-&gt;&gt;Twilio: Send SMS \"CONFIRM\"\n    Twilio-&gt;&gt;Webhooks: Incoming message webhook\n    Webhooks-&gt;&gt;Consumer: Get subscribers\n    Consumer-&gt;&gt;LocalAPI: Localize message\n    Consumer-&gt;&gt;Twilio: Send to all subscribers\n    Webhooks--&gt;&gt;Client: \"Sent to 5 subscribers\"</code></pre>"},{"location":"infrastructure/#deployment","title":"Deployment","text":"<p>All services run as containers in AWS ECS (Fargate), with:</p> <ul> <li>Application Load Balancer for HTTP/HTTPS traffic</li> <li>Amazon MSK for managed Kafka</li> <li>Amazon RDS for PostgreSQL</li> <li>Amazon ElastiCache for Redis</li> <li>S3 for static site hosting and Terraform state</li> <li>Route 53 for DNS</li> <li>ACM for SSL certificates</li> </ul>"},{"location":"scripts/","title":"Scripts","text":"<p>This page documents the PowerShell scripts used for development and maintenance.</p>"},{"location":"scripts/#root-scripts","title":"Root Scripts","text":""},{"location":"scripts/#start-devps1","title":"start-dev.ps1","text":"<p>Main development startup script. Starts all Docker services in the correct order.</p> <pre><code>./start-dev.ps1\n</code></pre> <p>What it does:</p> <ol> <li>Loads environment from <code>.env.external</code></li> <li>Starts infrastructure services (Kafka, PostgreSQL, Redis, etc.)</li> <li>Waits for Kafka broker to be ready</li> <li>Starts application services (APIs, Gateway, Web)</li> <li>Opens browser to <code>https://localhost:5050</code></li> </ol>"},{"location":"scripts/#configureps1","title":"configure.ps1","text":"<p>Generates <code>.env</code> files for services based on deployment mode.</p> <pre><code>./configure.ps1 -Mode &lt;Docker|Oidc|Local&gt;\n</code></pre> <p>Modes:</p> Mode Description <code>Docker</code> All services run in Docker containers (default) <code>Oidc</code> Uses external OIDC provider <code>Local</code> Services run on host machine <p>Generated files:</p> <ul> <li><code>dotnet/*/.env</code> - Service-specific environment variables</li> <li>Merges values from <code>.env.external</code> (API keys, secrets)</li> </ul>"},{"location":"scripts/#reset-envps1","title":"reset-env.ps1","text":"<p>Removes all generated <code>.env</code> files from the dotnet directory.</p> <pre><code>./reset-env.ps1\n</code></pre> <p>Use this to clean up before switching configuration modes.</p>"},{"location":"scripts/#clean-dotnetps1","title":"clean-dotnet.ps1","text":"<p>Removes all <code>bin/</code> and <code>obj/</code> directories from dotnet projects.</p> <pre><code>./clean-dotnet.ps1\n</code></pre> <p>Useful for forcing a clean rebuild or resolving build issues.</p>"},{"location":"scripts/#certificate-scripts","title":"Certificate Scripts","text":""},{"location":"scripts/#certsgenerate-certsps1","title":"certs/generate-certs.ps1","text":"<p>Generates SSL certificates for local HTTPS development.</p> <pre><code># First, create the PFX file\ndotnet dev-certs https -ep ./certs/aspnetapp.pfx\n\n# Then generate PEM files from it\n./certs/generate-certs.ps1\n</code></pre> <p>Generates:</p> <ul> <li><code>aspnetapp.crt</code> - Certificate file</li> <li><code>aspnetapp.key</code> - Private key file</li> </ul> <p>These are used by nginx and other services that require PEM-format certificates.</p>"},{"location":"scripts/#database-scripts","title":"Database Scripts","text":"<p>Located in the <code>db/</code> directory.</p>"},{"location":"scripts/#run-migrationsps1","title":"run-migrations.ps1","text":"<p>Runs Entity Framework migrations for a specific database context.</p> <pre><code>cd db\n./run-migrations.ps1 -Context &lt;ContextName&gt; -Project &lt;ProjectPath&gt;\n</code></pre> <p>Parameters:</p> Parameter Description <code>-Context</code> EF DbContext name (e.g., <code>UserDbContext</code>) <code>-Project</code> Path to the project containing the context <p>Example:</p> <pre><code>./run-migrations.ps1 -Context UserDbContext -Project ../dotnet/UserApi\n</code></pre>"},{"location":"scripts/#create-userdb-migrationps1","title":"create-userdb-migration.ps1","text":"<p>Creates a new migration for UserDb.</p> <pre><code>cd db\n./create-userdb-migration.ps1 &lt;MigrationName&gt;\n</code></pre> <p>Example:</p> <pre><code>./create-userdb-migration.ps1 AddPhoneVerificationTable\n</code></pre> <p>Similar scripts exist for other databases:</p> <ul> <li><code>create-productdb-migration.ps1</code></li> <li><code>create-paymentdb-migration.ps1</code></li> </ul>"},{"location":"scripts/#scaffold-ps1","title":"scaffold-*.ps1","text":"<p>Scaffolds entity classes from existing database tables (database-first approach).</p> <pre><code>./scaffold-userdb.ps1\n</code></pre>"},{"location":"scripts/#gateway-build-script","title":"Gateway Build Script","text":""},{"location":"scripts/#build-gatewayps1","title":"build-gateway.ps1","text":"<p>Located at <code>dotnet/GraphQLGateway/GraphQLGateway/build-gateway.ps1</code>.</p> <p>Builds the HotChocolate Fusion gateway configuration by composing subgraph schemas.</p> <pre><code>cd dotnet/GraphQLGateway/GraphQLGateway\n./build-gateway.ps1\n</code></pre> <p>What it does:</p> <ol> <li>Packs each subgraph schema (UserApi, ProductApi, PaymentApi)</li> <li>Composes them into a unified gateway configuration</li> <li>Outputs <code>gateway.fgp</code> (Fusion Gateway Package)</li> </ol> <p>When to run:</p> <ul> <li>After modifying any GraphQL schema in the subgraph APIs</li> <li>After adding new queries, mutations, or subscriptions</li> <li>When setting up a fresh development environment</li> </ul> <p>The gateway must be rebuilt whenever subgraph schemas change, or the gateway won't expose the new operations.</p>"},{"location":"data/","title":"Nudges Data Layer Overview","text":"<p>Nudges roughly follows a Domain-driven design concept with it's data persistence layer, which has many implications for this system.</p>"},{"location":"data/#ddd-approach","title":"DDD Approach","text":"<p>Following a DDD pattern, our data exists in multiple separate databases, each for a distinct domain.</p> <ul> <li>The user-related data all lives in the <code>userdb</code> database, implemented in PostgresQL.</li> <li>The product-related data all lives in the <code>productdb</code> database, implemented in PostgresQL.</li> <li>The payment-related data all lives in the <code>paymentdb</code> database, implemented in PostgresQL.</li> <li>Ephemeral data and some cached data lives in a Redis database. </li> </ul> <p>Management of the databases in Nudges are handled with a mix of local scripts to modify the local databases, and EF Core Migrations.</p>"},{"location":"data/#conventions","title":"Conventions","text":"<p>By convention, any changes needed to our databases should be done locally by any means seen fit at the time, and when those changes are finalized, the migration scripts should be run to ensure this change can be deployed in a consistent and recoverable way.</p>"},{"location":"data/#migrations","title":"Migrations","text":"<p>In the <code>db</code> directory, there are scripts for each Postgres database to handle modification tasks, each named for the relevant db.</p> <ul> <li><code>create-paymentdb-migration.ps1</code> generates a migration using the specified name for the PaymentDbContext and it's relevant database.  To call this script, <code>cd</code> into the <code>db</code> directory, and run it with the name of the new migration:  <code>./create-paymentdb-migration.ps1 MyNewMigration</code>.  Remember to use C# class naming conventions for the migration name.</li> </ul>"},{"location":"data/paymentdb/","title":"Payment Database","text":"<p>The <code>paymentdb</code> database stores payment confirmations and merchant service configurations.</p>"},{"location":"data/paymentdb/#schema","title":"Schema","text":"<pre><code>erDiagram\n    merchant_service ||--o{ payment_confirmation : processes\n\n    merchant_service {\n        int id PK\n        string name\n        string type\n    }\n\n    payment_confirmation {\n        uuid id PK\n        int merchant_service_id FK\n        string confirmation_code\n        timestamp created_at\n    }</code></pre>"},{"location":"data/paymentdb/#tables","title":"Tables","text":""},{"location":"data/paymentdb/#merchant_service","title":"<code>merchant_service</code>","text":"<p>Payment provider configurations (e.g., Stripe). Used to track which service processed a payment.</p>"},{"location":"data/paymentdb/#payment_confirmation","title":"<code>payment_confirmation</code>","text":"<p>Records of completed payments. Links to merchant service and stores the external confirmation code. Referenced by <code>plan_subscription</code> in productdb.</p>"},{"location":"data/productdb/","title":"Product Database","text":"<p>The <code>productdb</code> database stores subscription plans, pricing, and related entities.</p>"},{"location":"data/productdb/#schema","title":"Schema","text":"<pre><code>erDiagram\n    plan ||--o| plan_features : has\n    plan ||--o{ price_tier : contains\n    price_tier ||--o{ plan_subscription : \"subscribed via\"\n    price_tier ||--o{ discount_code : \"applies to\"\n    price_tier ||--o{ trial_offer : \"offers\"\n    discount_code ||--o{ discount : creates\n    plan_subscription ||--o{ discount : \"applied to\"\n    plan_subscription ||--o{ trial : starts\n    trial_offer ||--o{ trial : creates\n\n    plan {\n        uuid id PK\n        string name\n        string description\n        boolean is_active\n        string icon_url\n        string foreign_service_id\n    }\n\n    plan_features {\n        uuid plan_id PK,FK\n        boolean ai_support\n        int max_messages\n        int support_tier\n    }\n\n    price_tier {\n        uuid id PK\n        uuid plan_id FK\n        string name\n        decimal price\n        interval duration\n        string status\n        string foreign_service_id\n    }\n\n    plan_subscription {\n        uuid id PK\n        uuid price_tier_id FK\n        uuid client_id\n        uuid payment_confirmation_id\n        timestamp start_date\n        timestamp end_date\n        string status\n    }\n\n    discount_code {\n        uuid id PK\n        uuid price_tier_id FK\n        string code\n        string name\n        decimal discount\n        interval duration\n        timestamp expiry_date\n    }\n\n    discount {\n        uuid id PK\n        uuid discount_code_id FK\n        uuid plan_subscription_id FK\n    }\n\n    trial_offer {\n        uuid id PK\n        uuid price_tier_id FK\n    }\n\n    trial {\n        uuid id PK\n        uuid plan_subscription_id FK\n        uuid trial_offer_id FK\n    }</code></pre>"},{"location":"data/productdb/#tables","title":"Tables","text":""},{"location":"data/productdb/#plan","title":"<code>plan</code>","text":"<p>Base entity for subscription products. Each plan has features and one or more price tiers.</p>"},{"location":"data/productdb/#plan_features","title":"<code>plan_features</code>","text":"<p>Features included with a plan (AI support, message limits, support tier). One-to-one with plan.</p>"},{"location":"data/productdb/#price_tier","title":"<code>price_tier</code>","text":"<p>Pricing options for a plan. A plan may have multiple tiers (e.g., monthly, yearly) with different prices and durations.</p>"},{"location":"data/productdb/#plan_subscription","title":"<code>plan_subscription</code>","text":"<p>Records a client's subscription to a specific price tier, with start/end dates and payment confirmation reference.</p>"},{"location":"data/productdb/#discount_code","title":"<code>discount_code</code>","text":"<p>Promotional codes that can be applied to subscriptions for a discount percentage and duration.</p>"},{"location":"data/productdb/#trial_offer-trial","title":"<code>trial_offer</code> / <code>trial</code>","text":"<p>Trial period offerings and active trials for subscriptions.</p>"},{"location":"data/userdb/","title":"UserDb","text":"<p>UserDb stores user identity and role information. It implements a role-extension pattern where <code>user</code> is the identity root and <code>admin</code>, <code>client</code>, and <code>subscriber</code> are role extensions sharing the same primary key.</p>"},{"location":"data/userdb/#schema","title":"Schema","text":"<pre><code>erDiagram\n    user ||--o| admin : \"is\"\n    user ||--o| client : \"is\"\n    user ||--o| subscriber : \"is\"\n    client }o--o{ subscriber : \"client_subscriber\"\n\n    user {\n        uuid id PK\n        string subject\n        bytea phone_number_encrypted\n        string phone_number_hash UK\n        string locale\n        timestamp joined_date\n    }\n\n    admin {\n        uuid id PK,FK\n    }\n\n    client {\n        uuid id PK,FK\n        string name\n        string customer_id\n        string subscription_id\n        string slug UK\n    }\n\n    subscriber {\n        uuid id PK,FK\n    }\n\n    client_subscriber {\n        uuid client_id PK,FK\n        uuid subscriber_id PK,FK\n    }</code></pre>"},{"location":"data/userdb/#tables","title":"Tables","text":""},{"location":"data/userdb/#user","title":"user","text":"<p>Identity root table. All users have exactly one row here.</p> Column Type Description <code>id</code> uuid Primary key (auto-generated) <code>subject</code> string Keycloak subject identifier <code>phone_number_encrypted</code> bytea Encrypted phone number <code>phone_number_hash</code> string SHA-256 hash for lookups (unique) <code>locale</code> string User's locale (default: <code>en-US</code>) <code>joined_date</code> timestamp Registration timestamp"},{"location":"data/userdb/#admin","title":"admin","text":"<p>System administrators. Can manage all clients and system configuration.</p> Column Type Description <code>id</code> uuid FK to <code>user.id</code>"},{"location":"data/userdb/#client","title":"client","text":"<p>Business accounts that send announcements to subscribers.</p> Column Type Description <code>id</code> uuid FK to <code>user.id</code> <code>name</code> string Business display name <code>customer_id</code> string Stripe customer ID <code>subscription_id</code> string Stripe subscription ID <code>slug</code> string Unique URL-safe identifier (max 12 chars)"},{"location":"data/userdb/#subscriber","title":"subscriber","text":"<p>Users who receive SMS announcements from clients.</p> Column Type Description <code>id</code> uuid FK to <code>user.id</code>"},{"location":"data/userdb/#client_subscriber","title":"client_subscriber","text":"<p>Many-to-many join table linking clients to their subscribers.</p> Column Type Description <code>client_id</code> uuid FK to <code>client.id</code> <code>subscriber_id</code> uuid FK to <code>subscriber.id</code>"},{"location":"data/userdb/#role-extension-pattern","title":"Role Extension Pattern","text":"<p>A user can have multiple roles simultaneously. For example, a user could be both a <code>client</code> (sending announcements) and a <code>subscriber</code> (receiving announcements from other clients).</p> <pre><code>user (id: abc-123)\n  \u001c\u0000\u0000 client (id: abc-123)  -- same user is a client\n  \u0014\u0000\u0000 subscriber (id: abc-123)  -- and also a subscriber\n</code></pre> <p>This is implemented via 1:1 relationships where the role tables use the user's ID as both their primary key and foreign key.</p>"},{"location":"data/userdb/#phone-number-security","title":"Phone Number Security","text":"<p>Phone numbers are stored with defense-in-depth:</p> <ol> <li>Encrypted storage (<code>phone_number_encrypted</code>) - AES encryption for the actual number</li> <li>Hash for lookups (<code>phone_number_hash</code>) - SHA-256 hash enables finding users by phone without decryption</li> </ol>"},{"location":"data/userdb/#connection-string","title":"Connection String","text":"<pre><code>ConnectionStrings__UserDb=Host=localhost;Database=userdb;Username=postgres;Password=...\n</code></pre>"},{"location":"integrations/stripe/","title":"Stripe Integration","text":"<p>Nudges uses Stripe for payment processing and product/pricing management. The integration is bidirectional: Nudges creates products in Stripe, and Stripe webhooks sync data back.</p>"},{"location":"integrations/stripe/#data-flow","title":"Data Flow","text":"<pre><code>flowchart LR\n    subgraph Nudges\n        ProductApi\n        KafkaConsumer\n        Webhooks\n        Kafka\n    end\n\n    subgraph Stripe\n        Products\n        Prices\n        Checkout\n        StripeWebhooks[Webhooks]\n    end\n\n    ProductApi --&gt;|PlanCreatedEvent| Kafka\n    Kafka --&gt;|consume| KafkaConsumer\n    KafkaConsumer --&gt;|Create Product/Price| Products\n    KafkaConsumer --&gt;|Create Price| Prices\n\n    StripeWebhooks --&gt;|product.created| Webhooks\n    StripeWebhooks --&gt;|price.created| Webhooks\n    StripeWebhooks --&gt;|checkout.session.completed| Webhooks\n    Webhooks --&gt;|ForeignProductSyncEvent| Kafka</code></pre>"},{"location":"integrations/stripe/#outbound-nudges-stripe","title":"Outbound: Nudges \u2192 Stripe","text":"<p>Handled by KafkaConsumer (<code>StripeService</code>).</p>"},{"location":"integrations/stripe/#plan-product-sync","title":"Plan \u2192 Product Sync","text":"<p>When a plan is created in Nudges:</p> Event Stripe Action <code>PlanCreatedEvent</code> Creates Stripe Product <code>PlanUpdatedEvent</code> Updates Stripe Product"},{"location":"integrations/stripe/#price-tier-price-sync","title":"Price Tier \u2192 Price Sync","text":"Event Stripe Action <code>PriceTierCreatedEvent</code> Creates Stripe Price <code>PriceTierDeletedEvent</code> Archives Stripe Price"},{"location":"integrations/stripe/#client-customer-sync","title":"Client \u2192 Customer Sync","text":"Event Stripe Action <code>ClientCreatedEvent</code> Creates Stripe Customer"},{"location":"integrations/stripe/#inbound-stripe-nudges","title":"Inbound: Stripe \u2192 Nudges","text":"<p>Handled by Webhooks service at <code>/api/StripeWebhookHandler</code>.</p>"},{"location":"integrations/stripe/#product-events","title":"Product Events","text":"Stripe Event Nudges Action <code>product.created</code> Publishes <code>ForeignProductSyncEvent</code> to link Stripe ID <code>product.updated</code> Updates plan name, description, icon, active status <code>product.deleted</code> Deletes corresponding plan"},{"location":"integrations/stripe/#price-events","title":"Price Events","text":"Stripe Event Nudges Action <code>price.created</code> Creates price tier from Stripe price <code>price.updated</code> Updates price tier amount <code>price.deleted</code> Deletes price tier"},{"location":"integrations/stripe/#checkout-events","title":"Checkout Events","text":"Stripe Event Nudges Action <code>checkout.session.completed</code> Creates payment confirmation and plan subscription"},{"location":"integrations/stripe/#complete-flow-example","title":"Complete Flow Example","text":"<p>Creating a plan end-to-end:</p> <pre><code>sequenceDiagram\n    participant UI\n    participant ProductApi\n    participant Kafka\n    participant KafkaConsumer\n    participant Stripe\n    participant Webhooks\n\n    UI-&gt;&gt;ProductApi: CreatePlan mutation\n    ProductApi-&gt;&gt;ProductApi: Save plan to DB\n    ProductApi-&gt;&gt;Kafka: PlanCreatedEvent\n    ProductApi--&gt;&gt;UI: Plan created (no Stripe ID yet)\n\n    Kafka-&gt;&gt;KafkaConsumer: Consume PlanCreatedEvent\n    KafkaConsumer-&gt;&gt;Stripe: Create Product\n    Stripe--&gt;&gt;KafkaConsumer: Product created\n\n    Stripe-&gt;&gt;Webhooks: product.created webhook\n    Webhooks-&gt;&gt;Kafka: ForeignProductSyncEvent\n\n    Kafka-&gt;&gt;KafkaConsumer: Consume ForeignProductSyncEvent\n    KafkaConsumer-&gt;&gt;ProductApi: PatchPlan (add Stripe ID)\n    ProductApi--&gt;&gt;UI: onPlanUpdated subscription</code></pre>"},{"location":"integrations/stripe/#configuration","title":"Configuration","text":""},{"location":"integrations/stripe/#webhooks-service","title":"Webhooks Service","text":"<pre><code>STRIPE_API_KEY=sk_...\nSTRIPE_WEBHOOKS_SECRET=whsec_...\nWEBHOOKS_API_KEY=&lt;your-key&gt;\n</code></pre>"},{"location":"integrations/stripe/#kafkaconsumer","title":"KafkaConsumer","text":"<pre><code>STRIPE_API_KEY=sk_...\nSTRIPE_API_URL=https://api.stripe.com\n</code></pre>"},{"location":"integrations/stripe/#webhook-setup","title":"Webhook Setup","text":""},{"location":"integrations/stripe/#production","title":"Production","text":"<ol> <li>Go to Stripe Dashboard \u2192 Developers \u2192 Webhooks</li> <li>Add endpoint: <code>https://&lt;your-domain&gt;/api/StripeWebhookHandler?code=&lt;WEBHOOKS_API_KEY&gt;</code></li> <li>Select events:</li> <li><code>product.created</code>, <code>product.updated</code>, <code>product.deleted</code></li> <li><code>price.created</code>, <code>price.updated</code>, <code>price.deleted</code></li> <li><code>checkout.session.completed</code></li> <li>Copy the signing secret to <code>STRIPE_WEBHOOKS_SECRET</code></li> </ol>"},{"location":"integrations/stripe/#local-development","title":"Local Development","text":"<p>Use ngrok to expose your local webhook endpoint:</p> <pre><code># ngrok/ngrok.yml\ntunnels:\n  webhooks:\n    proto: http\n    addr: host.docker.internal:7071\n    domain: &lt;your-ngrok-domain&gt;\n</code></pre> <p>Or use the Stripe CLI:</p> <pre><code>stripe listen --forward-to localhost:7071/api/StripeWebhookHandler?code=your-key\n</code></pre>"},{"location":"integrations/stripe/#entity-mapping","title":"Entity Mapping","text":"Nudges Stripe Plan Product PriceTier Price Client Customer PlanSubscription Subscription PaymentConfirmation Checkout Session"},{"location":"integrations/stripe/#error-handling","title":"Error Handling","text":"<p>The KafkaConsumer uses Polly for resilience:</p> <ul> <li>Retry: 3 attempts with exponential backoff for transient Stripe API failures</li> <li>Circuit Breaker: Opens after 5 consecutive failures, preventing cascade failures</li> </ul>"},{"location":"integrations/twilio/","title":"Twilio Integration","text":"<p>Nudges uses Twilio for SMS messaging. The integration handles both outbound notifications (sending SMS to subscribers) and inbound messages (receiving commands via SMS).</p>"},{"location":"integrations/twilio/#data-flow","title":"Data Flow","text":"<pre><code>flowchart LR\n    subgraph Nudges\n        KafkaConsumer\n        Webhooks\n        Kafka\n        Localization[LocalizationApi]\n    end\n\n    subgraph Twilio\n        MessagingService[Messaging Service]\n        InboundSMS[Inbound SMS]\n    end\n\n    subgraph Users\n        Subscriber[Subscriber Phone]\n        Client[Client Phone]\n    end\n\n    Kafka --&gt;|SendSmsNotificationEvent| KafkaConsumer\n    KafkaConsumer --&gt;|Get localized text| Localization\n    KafkaConsumer --&gt;|Send SMS| MessagingService\n    MessagingService --&gt;|Deliver| Subscriber\n\n    Client --&gt;|Text message| InboundSMS\n    InboundSMS --&gt;|Webhook| Webhooks\n    Webhooks --&gt;|Event| Kafka</code></pre>"},{"location":"integrations/twilio/#outbound-nudges-twilio","title":"Outbound: Nudges \u2192 Twilio","text":"<p>Handled by KafkaConsumer (<code>TwilioNotifier</code>).</p>"},{"location":"integrations/twilio/#notification-events","title":"Notification Events","text":"Event Action <code>SendSmsNotificationEvent</code> Localizes message, sends via Twilio"},{"location":"integrations/twilio/#notification-flow","title":"Notification Flow","text":"<pre><code>sequenceDiagram\n    participant Service as Any Service\n    participant Kafka\n    participant Consumer as KafkaConsumer\n    participant Localization as LocalizationApi\n    participant Twilio\n\n    Service-&gt;&gt;Kafka: SendSmsNotificationEvent\n    Kafka-&gt;&gt;Consumer: Consume event\n    Consumer-&gt;&gt;Localization: GetLocalizedString(key, locale)\n    Localization--&gt;&gt;Consumer: Localized text\n    Consumer-&gt;&gt;Twilio: Send SMS\n    Twilio--&gt;&gt;Consumer: Message SID</code></pre>"},{"location":"integrations/twilio/#triggered-notifications","title":"Triggered Notifications","text":"Trigger Message User login Login confirmation SMS Client created Welcome SMS Plan subscription created Subscription confirmation Announcement sent Broadcast to all subscribers"},{"location":"integrations/twilio/#inbound-twilio-nudges","title":"Inbound: Twilio \u2192 Nudges","text":"<p>Handled by Webhooks service at <code>/api/TwilioWebhookHandler</code>.</p>"},{"location":"integrations/twilio/#sms-commands","title":"SMS Commands","text":"<p>Users can text commands to interact with the system:</p> Command Pattern Action <code>COMMANDS</code> <code>^commands$</code> Returns help text with links <code>HELP</code> <code>^help$</code> Returns help text with links <code>UNSUB &lt;n&gt;</code> <code>UNSUB (\\d+)</code> Unsubscribe from client by number <code>CONFIRM</code> <code>^CONFIRM$</code> Confirms pending announcement (any text) <code>.*</code> Drafts announcement (clients only)"},{"location":"integrations/twilio/#announcement-flow","title":"Announcement Flow","text":"<p>Clients can send announcements via SMS:</p> <pre><code>sequenceDiagram\n    participant Client as Client Phone\n    participant Twilio\n    participant Webhooks\n    participant Cache as WarpCache\n    participant Subscribers\n\n    Client-&gt;&gt;Twilio: \"Big sale tomorrow!\"\n    Twilio-&gt;&gt;Webhooks: Inbound webhook\n    Webhooks-&gt;&gt;Cache: Store draft (announcement:{phone})\n    Webhooks-&gt;&gt;Twilio: \"Reply CONFIRM to send\"\n    Twilio-&gt;&gt;Client: Confirmation prompt\n\n    Client-&gt;&gt;Twilio: \"CONFIRM\"\n    Twilio-&gt;&gt;Webhooks: Inbound webhook\n    Webhooks-&gt;&gt;Cache: Get draft\n    Webhooks-&gt;&gt;Subscribers: Send to all subscribers\n    Webhooks-&gt;&gt;Twilio: \"Sent to 47 subscribers\"\n    Twilio-&gt;&gt;Client: Success message</code></pre>"},{"location":"integrations/twilio/#ignored-keywords","title":"Ignored Keywords","text":"<p>Twilio's standard opt-in/opt-out keywords are acknowledged but not processed:</p> <ul> <li><code>STOP</code> - Opt out (handled by Twilio)</li> <li><code>START</code> - Opt back in (handled by Twilio)</li> <li><code>UNSTOP</code> - Opt back in (handled by Twilio)</li> <li><code>HELP</code> - Processed as command</li> </ul>"},{"location":"integrations/twilio/#configuration","title":"Configuration","text":""},{"location":"integrations/twilio/#webhooks-service","title":"Webhooks Service","text":"<pre><code>TWILIO_ACCOUNT_SID=AC...\nTWILIO_AUTH_TOKEN=&lt;token&gt;\nTWILIO_MESSAGE_SERVICE_SID=MG...\nWEBHOOKS_API_KEY=&lt;your-key&gt;\n\n# URLs included in SMS responses\nAccountUrl=https://app.example.com/account\nClientLinkBaseUri=https://app.example.com\n</code></pre>"},{"location":"integrations/twilio/#kafkaconsumer","title":"KafkaConsumer","text":"<pre><code>TWILIO_ACCOUNT_SID=AC...\nTWILIO_AUTH_TOKEN=&lt;token&gt;\nTWILIO_MESSAGE_SERVICE_SID=MG...\nLOCALIZATION_API_URL=http://localization-api:8888\n</code></pre>"},{"location":"integrations/twilio/#webhook-setup","title":"Webhook Setup","text":"<p>Configure Twilio to send inbound SMS to your webhook:</p> <ol> <li>Go to Twilio Console \u2192 Messaging \u2192 Services</li> <li>Select your Messaging Service</li> <li>Under \"Integration\", set webhook URL:</li> <li><code>https://&lt;your-domain&gt;/api/TwilioWebhookHandler?code=&lt;WEBHOOKS_API_KEY&gt;</code></li> </ol>"},{"location":"integrations/twilio/#local-development","title":"Local Development","text":"<p>Use ngrok to expose your local webhook endpoint:</p> <pre><code># ngrok/ngrok.yml\ntunnels:\n  webhooks:\n    proto: http\n    addr: host.docker.internal:7071\n    domain: &lt;your-ngrok-domain&gt;\n</code></pre>"},{"location":"integrations/twilio/#development-mode","title":"Development Mode","text":"<p>In development, the KafkaConsumer uses <code>LocalNotifier</code> instead of <code>TwilioNotifier</code>. SMS messages are logged to the console rather than sent via Twilio.</p> <pre><code>[INF] SMS to +15551234567: Welcome to Nudges! Your account is ready.\n</code></pre> <p>This allows testing the full notification flow without Twilio credentials or charges.</p>"},{"location":"integrations/twilio/#localization","title":"Localization","text":"<p>All SMS messages are localized via the LocalizationApi:</p> Resource Key en-US es-ES <code>WelcomeMessage</code> \"Welcome to Nudges!\" \"\u00a1Bienvenido a Nudges!\" <code>AnnouncementSent</code> \"Sent to {count} subscribers\" \"Enviado a {count} suscriptores\" <code>ClientHelpMessage</code> \"Reply COMMANDS for help\" \"Responde COMMANDS para ayuda\" <p>The user's locale is stored in <code>userdb.user.locale</code> and passed with each notification event.</p>"},{"location":"services/auth-api/","title":"AuthApi","text":"<p>The AuthApi is the primary authentication and authorization gateway for the Nudges platform. It handles OTP-based phone authentication, OAuth 2.0/OIDC integration with Keycloak, user provisioning, and token management.</p>"},{"location":"services/auth-api/#overview","title":"Overview","text":"<p>Key responsibilities:</p> <ul> <li>OTP Authentication - Generate and validate one-time passwords for phone-based verification</li> <li>OAuth 2.0/OIDC - Handle authorization code flow with PKCE via Keycloak</li> <li>User Provisioning - Automatically create users in Keycloak on first authentication</li> <li>Token Management - Issue and cache access tokens, store token IDs in HttpOnly cookies</li> <li>Event Publishing - Publish login/logout events to Kafka for downstream systems</li> </ul>"},{"location":"services/auth-api/#project-structure","title":"Project Structure","text":"<pre><code>AuthApi/\n\u251c\u2500\u2500 Program.cs              # Entry point and DI configuration\n\u251c\u2500\u2500 Handlers.cs             # API endpoint handlers\n\u251c\u2500\u2500 Settings.cs             # Configuration model classes\n\u251c\u2500\u2500 AppConfig.cs            # Configuration key constants\n\u251c\u2500\u2500 OtpVerifier.cs          # TOTP generation and validation\n\u251c\u2500\u2500 WarpCacheExtensions.cs  # Cache utilities for OTP, tokens, OIDC state\n\u2514\u2500\u2500 tests/\n    \u2514\u2500\u2500 AuthApi.Tests/      # Unit tests\n</code></pre>"},{"location":"services/auth-api/#api-endpoints","title":"API Endpoints","text":""},{"location":"services/auth-api/#post-otp","title":"POST /otp","text":"<p>Generate and send an OTP to a user's phone number.</p> <p>Request: <pre><code>{\n  \"phoneNumber\": \"+15551234567\"\n}\n</code></pre></p> <p>Process: 1. Generates a TOTP with 300-second validity 2. Stores the OTP secret in WarpCache (5 min TTL) 3. Publishes <code>SendSmsNotificationEvent</code> to Kafka 4. SMS delivered via downstream notification service</p> <p>Response: - Production: <code>200 OK</code> - Development: Returns OTP code for testing</p>"},{"location":"services/auth-api/#post-otpverify","title":"POST /otp/verify","text":"<p>Verify an OTP and authenticate the user.</p> <p>Headers: - <code>X-Role-Claim</code> (required): <code>\"client\"</code> or <code>\"subscriber\"</code></p> <p>Request: <pre><code>{\n  \"phoneNumber\": \"+15551234567\",\n  \"code\": \"123456\"\n}\n</code></pre></p> <p>Process: 1. Validates the role claim header 2. Retrieves and validates OTP from cache 3. Creates user in Keycloak (if new) with appropriate group 4. Exchanges credentials for access token 5. Caches token with generated token ID 6. Sets <code>TokenId</code> HttpOnly cookie 7. Publishes <code>UserLoggedInEvent</code> to Kafka</p> <p>Response: - Success: <code>200 OK</code> + <code>TokenId</code> cookie - Error: <code>400 Bad Request</code> with error message</p>"},{"location":"services/auth-api/#get-login","title":"GET /login","text":"<p>Initiate OAuth 2.0 authorization code flow with PKCE.</p> <p>Query Parameters: - <code>redirectUri</code> (required): Client application's callback URL</p> <p>Process: 1. Generates PKCE code verifier and challenge 2. Creates OAuth state with redirect info 3. Stores code verifier in cache (5 min TTL) 4. Redirects to Keycloak authorization endpoint</p> <p>Response: <code>302 Redirect</code> to Keycloak login page</p>"},{"location":"services/auth-api/#get-redirect","title":"GET /redirect","text":"<p>OAuth callback endpoint for code-to-token exchange.</p> <p>Query Parameters: - <code>code</code>: Authorization code from Keycloak - <code>state</code>: Base64url-encoded OAuth state</p> <p>Process: 1. Validates OAuth state and retrieves PKCE verifier 2. Exchanges authorization code for tokens 3. Extracts claims from JWT (phone, locale) 4. Caches token and sets <code>TokenId</code> cookie 5. Publishes <code>UserLoggedInEvent</code> to Kafka 6. Redirects to original client redirect URI</p> <p>Response: <code>302 Redirect</code> to client application</p>"},{"location":"services/auth-api/#authentication-flows","title":"Authentication Flows","text":""},{"location":"services/auth-api/#otp-flow-phone-verification","title":"OTP Flow (Phone Verification)","text":"<pre><code>sequenceDiagram\n    participant Client\n    participant AuthApi\n    participant Keycloak\n    participant WarpCache\n    participant Kafka\n\n    Client-&gt;&gt;AuthApi: POST /otp (phone)\n    Note over AuthApi: Generate TOTP\n    AuthApi-&gt;&gt;WarpCache: Store secret (5 min TTL)\n    AuthApi-&gt;&gt;Kafka: Publish SMS notification\n    AuthApi--&gt;&gt;Client: 200 OK\n\n    Client-&gt;&gt;AuthApi: POST /otp/verify (code)\n    Note over AuthApi: Validate code\n    AuthApi-&gt;&gt;Keycloak: Create user (if new)\n    AuthApi-&gt;&gt;Keycloak: Get token\n    AuthApi-&gt;&gt;WarpCache: Cache token\n    AuthApi-&gt;&gt;Kafka: Publish login event\n    AuthApi--&gt;&gt;Client: 200 OK + TokenId cookie</code></pre>"},{"location":"services/auth-api/#oauth-20-pkce-flow","title":"OAuth 2.0 PKCE Flow","text":"<pre><code>sequenceDiagram\n    participant App as Client App\n    participant AuthApi\n    participant Keycloak\n    participant WarpCache\n\n    App-&gt;&gt;AuthApi: GET /login?redirectUri=...\n    Note over AuthApi: Generate PKCE pair\n    AuthApi-&gt;&gt;WarpCache: Store verifier (5 min TTL)\n    AuthApi--&gt;&gt;App: 302 Redirect to Keycloak\n\n    App-&gt;&gt;Keycloak: Login page\n    Keycloak--&gt;&gt;App: 302 /redirect?code&amp;state\n\n    App-&gt;&gt;AuthApi: GET /redirect?code&amp;state\n    AuthApi-&gt;&gt;WarpCache: Retrieve verifier\n    AuthApi-&gt;&gt;Keycloak: Exchange code (with PKCE)\n    Keycloak--&gt;&gt;AuthApi: Access token\n    AuthApi-&gt;&gt;WarpCache: Cache token\n    AuthApi--&gt;&gt;App: 302 Redirect + TokenId cookie</code></pre>"},{"location":"services/auth-api/#token-storage","title":"Token Storage","text":"<p>Tokens are stored server-side in WarpCache, with only a token ID exposed to clients:</p> Cache Key Content TTL <code>otp:{phone}:secret</code> OTP secret 5 min <code>token:{tokenId}</code> Access token Token expiry <code>oidc:{state}</code> PKCE code verifier 5 min <p>The <code>TokenId</code> cookie is HttpOnly and Secure, preventing XSS attacks from accessing the actual token.</p>"},{"location":"services/auth-api/#configuration","title":"Configuration","text":""},{"location":"services/auth-api/#required-environment-variables","title":"Required Environment Variables","text":"<pre><code># Keycloak/OIDC\nOidc__Realm=nudges\nOidc__ServerUrl=https://keycloak.example.com\nOidc__ClientId=auth-api\nOidc__ClientSecret=&lt;secret&gt;\nOidc__AdminCredentials__Username=admin\nOidc__AdminCredentials__Password=&lt;password&gt;\n\n# Kafka\nKafka__BrokerList=kafka:9092\n\n# Distributed Cache\nWarpCache__Url=http://warpcache:7777\n\n# Observability (optional)\nOtlp__Endpoint=http://otel-collector:4317\n\n# Development only\nIGNORE_SSL_CERT_VALIDATION=true\n</code></pre>"},{"location":"services/auth-api/#dependencies","title":"Dependencies","text":""},{"location":"services/auth-api/#internal-projects","title":"Internal Projects","text":"<ul> <li><code>Nudges.Auth</code> - Authentication interfaces and models</li> <li><code>Nudges.Auth.Keycloak</code> - Keycloak OIDC client implementation</li> <li><code>Nudges.Auth.Web</code> - Web authentication utilities</li> <li><code>Nudges.Kafka</code> / <code>Nudges.Kafka.Events</code> - Event publishing</li> <li><code>Nudges.Telemetry</code> - OpenTelemetry integration</li> <li><code>Precision.WarpCache.Grpc.Client</code> - Distributed cache client</li> </ul>"},{"location":"services/auth-api/#external-services","title":"External Services","text":"<ul> <li>Keycloak - Identity provider (user management, token issuance)</li> <li>Kafka - Event streaming (login events, SMS notifications)</li> <li>WarpCache - Distributed caching (tokens, OTP secrets)</li> </ul>"},{"location":"services/auth-api/#kafka-events","title":"Kafka Events","text":"<p>The service publishes to two Kafka topics:</p>"},{"location":"services/auth-api/#notifications","title":"notifications","text":"<ul> <li>Event: <code>SendSmsNotificationEvent</code></li> <li>Trigger: OTP generation</li> <li>Content: Phone number, OTP code, resource key</li> </ul>"},{"location":"services/auth-api/#user-authentication","title":"user-authentication","text":"<ul> <li>Event: <code>UserLoggedInEvent</code></li> <li>Trigger: Successful login (OTP or OAuth)</li> <li>Content: Phone number, locale</li> </ul>"},{"location":"services/auth-api/#local-development","title":"Local Development","text":"<pre><code>cd dotnet/AuthApi\ndotnet run\n</code></pre> <p>Default port: <code>5555</code> (HTTPS)</p> <p>In development mode: - OTP codes are returned in the response (not just sent via SMS) - SSL certificate validation can be disabled for local Keycloak</p>"},{"location":"services/auth-api/#security-features","title":"Security Features","text":"<ul> <li>PKCE - Prevents authorization code interception</li> <li>State Parameter - Prevents CSRF attacks</li> <li>HttpOnly Cookies - Prevents XSS token theft</li> <li>Server-Side Token Storage - Tokens never exposed to client</li> <li>TOTP - Time-based codes with 5-minute windows</li> </ul>"},{"location":"services/auth-init/","title":"AuthInit","text":"<p>AuthInit is a one-time initialization CLI tool that sets up the default admin user in both the PostgreSQL database and Keycloak. Run this once during initial system setup before starting other services.</p>"},{"location":"services/auth-init/#what-it-does","title":"What It Does","text":"<ol> <li>Creates default admin user in the database (phone: <code>+15555555555</code>)</li> <li>Creates matching admin user in Keycloak with group <code>admins</code></li> <li>Links the database record to the Keycloak user ID (Subject)</li> </ol>"},{"location":"services/auth-init/#running","title":"Running","text":""},{"location":"services/auth-init/#command-line","title":"Command Line","text":"<pre><code>dotnet Nudges.AuthInit.dll seed\n</code></pre>"},{"location":"services/auth-init/#docker","title":"Docker","text":"<pre><code>docker compose up auth-init\n</code></pre>"},{"location":"services/auth-init/#local-development","title":"Local Development","text":"<pre><code>cd dotnet/Nudges.AuthInit\ndotnet run -- seed\n</code></pre>"},{"location":"services/auth-init/#configuration","title":"Configuration","text":"<p>Required environment variables:</p> <pre><code># Database\nConnectionStrings__UserDb=Host=localhost;Database=userdb;...\n\n# Security\nHashSettings__HashKeyBase64=&lt;base64-key&gt;\nEncryptionSettings__Key=&lt;base64-key&gt;\n\n# Keycloak\nOidc__Realm=nudges\nOidc__ServerUrl=https://keycloak.local:8443\nOidc__ClientId=auth-init\nOidc__ClientSecret=&lt;secret&gt;\nOidc__AdminCredentials__Username=admin\nOidc__AdminCredentials__Password=&lt;password&gt;\n</code></pre>"},{"location":"services/auth-init/#notes","title":"Notes","text":"<ul> <li>Idempotent - Safe to run multiple times; skips if admin already exists</li> <li>Run first - Other services depend on the admin user existing</li> <li>Development password - Default Keycloak password is <code>pass</code></li> <li>Phone numbers are hashed in the database but stored as plaintext username in Keycloak</li> </ul>"},{"location":"services/db-migrator/","title":"Database Migrator","text":"<p>The database migrator uses Entity Framework Core to manage schema changes across three PostgreSQL databases. Each database has its own DbContext and independent migration history.</p>"},{"location":"services/db-migrator/#databases","title":"Databases","text":"Database DbContext Purpose <code>userdb</code> <code>UserDbContext</code> Users, clients, subscribers, admins <code>productdb</code> <code>ProductDbContext</code> Plans, pricing, subscriptions, trials, discounts <code>paymentdb</code> <code>PaymentDbContext</code> Payment confirmations, merchant services"},{"location":"services/db-migrator/#running-migrations","title":"Running Migrations","text":""},{"location":"services/db-migrator/#locally","title":"Locally","text":"<p>From the <code>db/</code> directory:</p> <pre><code>.\\run-migrations.ps1 UserDbContext\n.\\run-migrations.ps1 ProductDbContext\n.\\run-migrations.ps1 PaymentDbContext\n</code></pre>"},{"location":"services/db-migrator/#in-dockerdeployment","title":"In Docker/Deployment","text":"<p>The <code>Migrator.Dockerfile</code> creates self-contained executables for each database:</p> <pre><code>./migrateUserDb\n./migrateProductDb\n./migratePaymentDb\n</code></pre> <p>These bundles don't require .NET runtime on the target system.</p>"},{"location":"services/db-migrator/#creating-migrations","title":"Creating Migrations","text":""},{"location":"services/db-migrator/#workflow","title":"Workflow","text":"<ol> <li>Modify your model classes in <code>Nudges.Data/&lt;Domain&gt;/</code></li> <li>Create the migration</li> <li>Apply and test locally</li> <li>Commit migration files</li> </ol>"},{"location":"services/db-migrator/#commands","title":"Commands","text":"<p>From the <code>db/</code> directory:</p> <pre><code># UserDb\n.\\create-userdb-migration.ps1 \"AddNewColumn\"\n\n# ProductDb\n.\\create-productdb-migration.ps1 \"AddDiscountTable\"\n\n# PaymentDb\n.\\create-paymentdb-migration.ps1 \"AddPaymentStatus\"\n</code></pre> <p>Migration files are created in:</p> <ul> <li><code>dotnet/Nudges.Data/Users/Migrations/</code></li> <li><code>dotnet/Nudges.Data/Products/Migrations/</code></li> <li><code>dotnet/Nudges.Data/Payments/Migrations/</code></li> </ul>"},{"location":"services/db-migrator/#helper-scripts","title":"Helper Scripts","text":"Script Purpose <code>run-migrations.ps1 &lt;Context&gt;</code> Apply pending migrations <code>create-userdb-migration.ps1 \"Name\"</code> Create UserDb migration <code>create-productdb-migration.ps1 \"Name\"</code> Create ProductDb migration <code>create-paymentdb-migration.ps1 \"Name\"</code> Create PaymentDb migration <code>scaffold-userdb.ps1</code> Reverse-engineer models from existing DB <code>scaffold-productdb.ps1</code> Reverse-engineer models from existing DB <code>scaffold-paymentdb.ps1</code> Reverse-engineer models from existing DB"},{"location":"services/db-migrator/#configuration","title":"Configuration","text":"<p>Required environment variables:</p> <pre><code>ConnectionStrings__UserDb=Host=localhost;Database=userdb;Username=userdb;Password=...\nConnectionStrings__ProductDb=Host=localhost;Database=productdb;Username=productdb;Password=...\nConnectionStrings__PaymentDb=Host=localhost;Database=paymentdb;Username=paymentdb;Password=...\n</code></pre>"},{"location":"services/db-migrator/#notes","title":"Notes","text":"<ul> <li>Each DbContext maintains independent migration history - create and apply migrations separately</li> <li>PostgreSQL columns use <code>snake_case</code>, C# properties use <code>PascalCase</code></li> <li>Don't edit <code>*ModelSnapshot.cs</code> files manually</li> <li>Migration names should use PascalCase (e.g., <code>AddPhoneEncryption</code>)</li> </ul>"},{"location":"services/db-seeder/","title":"Database Seeder","text":"<p>The DbSeeder is a CLI tool that populates initial data into PostgreSQL databases and Redis cache.</p>"},{"location":"services/db-seeder/#commands","title":"Commands","text":"<pre><code># Seed PostgreSQL databases\ndotnet run -- db\n\n# Seed Redis cache with Stripe products\ndotnet run -- redis\n</code></pre>"},{"location":"services/db-seeder/#what-it-seeds","title":"What It Seeds","text":""},{"location":"services/db-seeder/#db-command","title":"<code>db</code> Command","text":"<p>Seeds the PostgreSQL user database with:</p> <ul> <li>Default admin client - Phone: <code>+15555555555</code>, slug: <code>nudges</code>, name: <code>Nudges</code></li> </ul>"},{"location":"services/db-seeder/#redis-command","title":"<code>redis</code> Command","text":"<p>Fetches data from Stripe and caches in Redis:</p> <ul> <li>Product prices - Active service-type products from Stripe</li> <li>Price metadata - Limits and other price properties</li> </ul>"},{"location":"services/db-seeder/#running","title":"Running","text":""},{"location":"services/db-seeder/#local-development","title":"Local Development","text":"<pre><code>cd dotnet\ndotnet run --project tools/DbSeeder/DbSeeder.csproj -- db\ndotnet run --project tools/DbSeeder/DbSeeder.csproj -- redis\n</code></pre>"},{"location":"services/db-seeder/#docker","title":"Docker","text":"<pre><code># Build\ndocker build -f dotnet/DbSeeder.Dockerfile -t dbseeder:latest .\n\n# Run db seeding (default)\ndocker run --env-file .env dbseeder:latest\n\n# Run redis seeding\ndocker run --env-file .env dbseeder:latest redis\n</code></pre>"},{"location":"services/db-seeder/#configuration","title":"Configuration","text":"<p>Required environment variables:</p> <pre><code># Database connections\nConnectionStrings__UserDb=Host=localhost;Database=userdb;...\nConnectionStrings__ProductDb=Host=localhost;Database=productdb;...\nConnectionStrings__PaymentDb=Host=localhost;Database=paymentdb;...\n\n# Security\nHashSettings__HashKeyBase64=&lt;base64-key&gt;\nEncryptionSettings__Key=&lt;base64-key&gt;\n\n# Redis seeding\nREDIS_URL=localhost:6379\nSTRIPE_API_KEY=sk_...\n</code></pre>"},{"location":"services/db-seeder/#notes","title":"Notes","text":"<ul> <li>The <code>db</code> command expects a default admin user to already exist</li> <li>Phone numbers are hashed before storage</li> <li>Sensitive fields use AES-GCM encryption via EF Core interceptors</li> </ul>"},{"location":"services/graph-monitor/","title":"Graph Monitor","text":"<p>GraphMonitor is a simple HTTP-based cache service that stores and retrieves GraphQL endpoint URLs and schemas. It acts as a registry for GraphQL information, allowing services to look up endpoints without direct knowledge of them.</p>"},{"location":"services/graph-monitor/#endpoints","title":"Endpoints","text":"Method Path Purpose Auth GET <code>/health</code> Health check None GET <code>/{name}</code> Retrieve stored graph URL X-Api-Key POST <code>/{name}</code> Store a graph URL X-Api-Key GET <code>/schema</code> Retrieve stored GraphQL schema X-Api-Key POST <code>/schema</code> Store GraphQL schema X-Api-Key"},{"location":"services/graph-monitor/#usage","title":"Usage","text":""},{"location":"services/graph-monitor/#store-a-graph-url","title":"Store a Graph URL","text":"<pre><code>curl -X POST http://localhost:5145/my-api \\\n  -H \"X-Api-Key: your-key\" \\\n  -H \"Content-Type: text/plain\" \\\n  -d \"http://api.example.com/graphql\"\n</code></pre>"},{"location":"services/graph-monitor/#retrieve-a-graph-url","title":"Retrieve a Graph URL","text":"<pre><code>curl http://localhost:5145/my-api \\\n  -H \"X-Api-Key: your-key\"\n</code></pre>"},{"location":"services/graph-monitor/#health-check","title":"Health Check","text":"<pre><code>curl http://localhost:5145/health\n</code></pre>"},{"location":"services/graph-monitor/#running","title":"Running","text":""},{"location":"services/graph-monitor/#local-development","title":"Local Development","text":"<pre><code>cd dotnet/GraphMonitor\n$env:REDIS_URL=\"localhost:6379\"\n$env:MONITOR_API_KEY=\"dev-key\"\ndotnet run\n</code></pre> <p>Default port: <code>5145</code></p>"},{"location":"services/graph-monitor/#docker","title":"Docker","text":"<pre><code>docker build -f dotnet/GraphMonitor.Dockerfile -t graph-monitor .\ndocker run -e REDIS_URL=redis:6379 -e MONITOR_API_KEY=secret -p 5145:5145 graph-monitor\n</code></pre>"},{"location":"services/graph-monitor/#configuration","title":"Configuration","text":"<p>Required environment variables:</p> <pre><code>REDIS_URL=localhost:6379\nMONITOR_API_KEY=your-secret-key\n</code></pre>"},{"location":"services/graph-monitor/#notes","title":"Notes","text":"<ul> <li>All endpoints except <code>/health</code> require the <code>X-Api-Key</code> header</li> <li>Data is stored in Redis with keys like <code>graph:{name}</code> and <code>graph:schema</code></li> <li>Built with AOT compilation for fast startup and small image size</li> </ul>"},{"location":"services/graphql-gateway/","title":"GraphQL Gateway","text":"<p>The GraphQL Gateway is a federation gateway that composes multiple GraphQL subgraph services into a single unified API. Built using HotChocolate Fusion.</p>"},{"location":"services/graphql-gateway/#overview","title":"Overview","text":"<p>The gateway federates three backend services:</p> Subgraph Port (Local) Purpose UserApi 5300 User management, profiles ProductApi 5200 Products, pricing, plans PaymentApi 5400 Payments, subscriptions <p>All queries and mutations go through the gateway at <code>/graphql</code>.</p>"},{"location":"services/graphql-gateway/#architecture","title":"Architecture","text":"<pre><code>flowchart LR\n    Client --&gt; Gateway[GraphQL Gateway]\n    Gateway --&gt; UserApi\n    Gateway --&gt; ProductApi\n    Gateway --&gt; PaymentApi\n    Gateway --&gt; WarpCache[WarpCache]\n\n    subgraph Subgraphs\n        UserApi\n        ProductApi\n        PaymentApi\n    end</code></pre>"},{"location":"services/graphql-gateway/#authentication","title":"Authentication","text":"<p>The gateway handles token resolution via WarpCache:</p> <ol> <li>Client sends <code>Authorization: Bearer {tokenId}</code> or <code>TokenId</code> cookie</li> <li>Gateway looks up <code>token:{tokenId}</code> in WarpCache</li> <li>If found, forwards actual JWT to subgraphs</li> <li>Subgraphs validate JWT independently via Keycloak</li> </ol> <p>This keeps actual tokens server-side and enables token revocation.</p>"},{"location":"services/graphql-gateway/#building","title":"Building","text":""},{"location":"services/graphql-gateway/#local-development","title":"Local Development","text":"<pre><code>cd dotnet/GraphQLGateway/GraphQLGateway\n./build-gateway.ps1\ndotnet run\n</code></pre> <p>Gateway runs at <code>https://localhost:5000/graphql</code></p>"},{"location":"services/graphql-gateway/#docker","title":"Docker","text":"<p>The Dockerfile handles subgraph composition at build time:</p> <ol> <li>Fetches subgraph URLs from GraphMonitor service</li> <li>Exports schemas from each subgraph</li> <li>Packs and composes into <code>gateway.fgp</code></li> <li>Final image runs the composed gateway</li> </ol> <pre><code>docker build -f dotnet/GraphQLGateway.Dockerfile -t graphql-gateway .\n</code></pre>"},{"location":"services/graphql-gateway/#configuration","title":"Configuration","text":"<pre><code># Distributed cache (for token resolution)\nWarpCache__Url=http://warpcache:7777\n\n# Telemetry (optional)\nOtlp__Endpoint=http://otel-collector:4317\n</code></pre>"},{"location":"services/graphql-gateway/#features","title":"Features","text":""},{"location":"services/graphql-gateway/#resilience-polly","title":"Resilience (Polly)","text":"<ul> <li>Retry: 3 attempts with exponential backoff</li> <li>Circuit Breaker: Opens after 3 failures, 10-second recovery</li> </ul>"},{"location":"services/graphql-gateway/#observability-opentelemetry","title":"Observability (OpenTelemetry)","text":"<ul> <li>Metrics: ASP.NET Core, Kestrel, HTTP client</li> <li>Traces: GraphQL operations, resolver execution, downstream calls</li> <li>Logs: Exported via OTLP</li> </ul>"},{"location":"services/graphql-gateway/#dependencies","title":"Dependencies","text":"<ul> <li>Upstream: UserApi, ProductApi, PaymentApi running</li> <li>WarpCache: For JWT token resolution</li> <li>GraphMonitor: For subgraph URL discovery (build time)</li> </ul>"},{"location":"services/graphql-gateway/#subgraph-composition","title":"Subgraph Composition","text":"<p>At build time, schemas are composed using HotChocolate Fusion:</p> <pre><code># Configure subgraph\ndotnet fusion subgraph config set name \"UserApi\" ...\n\n# Export schema\ndotnet run --project UserApi -- schema export --output schema.graphql\n\n# Pack subgraph\ndotnet fusion subgraph pack -w ./UserApi\n\n# Compose gateway\ndotnet fusion compose -p ./gateway -s ./UserApi -s ./ProductApi -s ./PaymentApi\n</code></pre> <p>The resulting <code>gateway.fgp</code> file is loaded at runtime.</p>"},{"location":"services/kafka-consumer/","title":"KafkaConsumer","text":"<p>The KafkaConsumer service is a message-driven event processor that listens to Kafka topics and executes business logic based on events published by other services. It acts as a critical integration hub, handling domain events and translating them into downstream actions such as GraphQL API calls and external service integrations (Stripe, Twilio).</p>"},{"location":"services/kafka-consumer/#overview","title":"Overview","text":"<p>The service runs as a CLI application that accepts a topic name as a command-line argument. Each topic has its own middleware pipeline and configuration, allowing independent scaling and deployment of consumers per topic.</p> <pre><code>dotnet run -- &lt;topic-command&gt;\n</code></pre> <p>Available commands:</p> Command Topic Description <code>notifications</code> Notifications SMS notification delivery <code>plans</code> Plans Plan creation and updates <code>price-tiers</code> PriceTiers Pricing tier management <code>plan-subscriptions</code> PlanSubscriptions Subscription lifecycle events <code>payments</code> Payments Payment confirmations <code>clients</code> Clients Client creation and updates <code>user-authentication</code> UserAuthentication User login/logout events <code>foreign-products</code> ForeignProducts External product synchronization"},{"location":"services/kafka-consumer/#architecture","title":"Architecture","text":""},{"location":"services/kafka-consumer/#message-flow","title":"Message Flow","text":"<pre><code>Kafka Topic\n    \u2193\nKafkaMessageProcessor\n    \u2193\nTracingMiddleware (OpenTelemetry context)\n    \u2193\n[Optional: Retry/CircuitBreaker Middleware]\n    \u2193\nDomain-Specific Middleware\n    \u251c\u2192 Parse event type\n    \u251c\u2192 Execute handler logic\n    \u251c\u2192 Call external APIs (GraphQL, Stripe, Twilio)\n    \u2514\u2192 Produce downstream events (optional)\n</code></pre>"},{"location":"services/kafka-consumer/#project-structure","title":"Project Structure","text":"<pre><code>KafkaConsumer/\n\u251c\u2500\u2500 Program.cs                    # Entry point with CLI routing\n\u251c\u2500\u2500 HandlerBuilders.cs            # Service configuration per topic\n\u251c\u2500\u2500 MessageHandlerService.cs      # Hosted service running processor\n\u251c\u2500\u2500 Middleware/                   # Event handlers by message type\n\u2502   \u251c\u2500\u2500 ClientMessageMiddleware.cs\n\u2502   \u251c\u2500\u2500 NotificationMessageMiddleware.cs\n\u2502   \u251c\u2500\u2500 PaymentMessageMiddleware.cs\n\u2502   \u251c\u2500\u2500 PlanMessageMiddleware.cs\n\u2502   \u251c\u2500\u2500 PlanSubscriptionMiddleware.cs\n\u2502   \u251c\u2500\u2500 PriceTierMessageMiddleware.cs\n\u2502   \u251c\u2500\u2500 UserAuthenticationMessageMiddleware.cs\n\u2502   \u2514\u2500\u2500 ForeignProductMessageMiddleware.cs\n\u251c\u2500\u2500 Services/                     # Business logic and integrations\n\u2502   \u251c\u2500\u2500 StripeService.cs          # Stripe integration\n\u2502   \u251c\u2500\u2500 TwilioNotifier.cs         # SMS delivery (production)\n\u2502   \u2514\u2500\u2500 LocalNotifier.cs          # SMS logging (development)\n\u2514\u2500\u2500 GraphQL/                      # Generated GraphQL client code\n    \u2514\u2500\u2500 Mutations/                # GraphQL mutation definitions\n</code></pre>"},{"location":"services/kafka-consumer/#middleware-handlers","title":"Middleware Handlers","text":"<p>Each middleware handles specific event types from its topic:</p>"},{"location":"services/kafka-consumer/#clientmessagemiddleware","title":"ClientMessageMiddleware","text":"<p>Handles client lifecycle events.</p> Event Action <code>ClientCreatedEvent</code> Creates Stripe customer, sends welcome SMS <code>ClientUpdatedEvent</code> Sends notification about updated data"},{"location":"services/kafka-consumer/#notificationmessagemiddleware","title":"NotificationMessageMiddleware","text":"<p>Handles SMS notification delivery.</p> Event Action <code>SendSmsNotificationEvent</code> Localizes text, sends via Twilio"},{"location":"services/kafka-consumer/#paymentmessagemiddleware","title":"PaymentMessageMiddleware","text":"<p>Handles payment confirmations.</p> Event Action <code>PaymentCompletedEvent</code> Creates plan subscription (dev mode)"},{"location":"services/kafka-consumer/#planmessagemiddleware","title":"PlanMessageMiddleware","text":"<p>Handles plan management with resilience policies (retry, circuit breaker).</p> Event Action <code>PlanCreatedEvent</code> Creates product in Stripe <code>PlanUpdatedEvent</code> Updates product in Stripe"},{"location":"services/kafka-consumer/#plansubscriptionmiddleware","title":"PlanSubscriptionMiddleware","text":"<p>Handles subscription lifecycle.</p> Event Action <code>PlanSubscriptionCreatedEvent</code> Updates client, publishes notification"},{"location":"services/kafka-consumer/#pricetiermessagemiddleware","title":"PriceTierMessageMiddleware","text":"<p>Handles pricing changes.</p> Event Action <code>PriceTierCreatedEvent</code> Creates price in Stripe <code>PriceTierUpdatedEvent</code> Updates pricing via GraphQL <code>PriceTierDeletedEvent</code> Removes price from Stripe"},{"location":"services/kafka-consumer/#userauthenticationmessagemiddleware","title":"UserAuthenticationMessageMiddleware","text":"<p>Handles authentication events.</p> Event Action <code>UserLoggedInEvent</code> Sends login confirmation SMS <code>UserLoggedOutEvent</code> (Logged only)"},{"location":"services/kafka-consumer/#foreignproductmessagemiddleware","title":"ForeignProductMessageMiddleware","text":"<p>Handles external product synchronization (e.g., from Stripe webhooks).</p> Event Action <code>ForeignProductCreatedEvent</code> Maps external product to local plan <code>ForeignProductSynchronizedEvent</code> Syncs plan data from external source"},{"location":"services/kafka-consumer/#configuration","title":"Configuration","text":""},{"location":"services/kafka-consumer/#required-environment-variables","title":"Required Environment Variables","text":"<pre><code># Kafka\nKafka__BrokerList=kafka:29092\n\n# GraphQL API\nGRAPHQL_API_URL=http://graphql-gateway:5443/graphql\n\n# Authentication\nOidc__Realm=nudges\nOidc__ServerUrl=https://auth.example.com\nOidc__ClientId=kafka-consumer\nOidc__ClientSecret=&lt;secret&gt;\nAUTH_API_URL=https://auth-api.example.com\n\n# Stripe\nSTRIPE_API_KEY=sk_test_...\nSTRIPE_API_URL=https://api.stripe.com\n\n# Twilio (SMS)\nTWILIO_ACCOUNT_SID=AC...\nTWILIO_AUTH_TOKEN=&lt;token&gt;\nTWILIO_MESSAGE_SERVICE_SID=MG...\n\n# Localization\nLOCALIZATION_API_URL=http://localization-api:5000\n\n# Caching\nREDIS_URL=redis:6379\nWarpCache__Url=http://warpcache:5000\n\n# Observability (optional)\nOtlp__Endpoint=http://otel-collector:4317\n</code></pre>"},{"location":"services/kafka-consumer/#dependencies","title":"Dependencies","text":""},{"location":"services/kafka-consumer/#internal-projects","title":"Internal Projects","text":"<ul> <li><code>Nudges.Kafka</code> - Kafka infrastructure and message processor</li> <li><code>Nudges.Kafka.Events</code> - Event type definitions</li> <li><code>Nudges.Contracts</code> - Domain models</li> <li><code>Nudges.Auth</code> / <code>Nudges.Auth.Web</code> - Authentication</li> <li><code>Nudges.Telemetry</code> - OpenTelemetry integration</li> <li><code>Nudges.Localization.Client</code> - Text localization</li> <li><code>Nudges.Stripe</code> - Stripe utilities</li> <li><code>Monads</code> - Result/Maybe error handling</li> <li><code>Precision.WarpCache</code> - Distributed caching</li> </ul>"},{"location":"services/kafka-consumer/#external-services","title":"External Services","text":"<ul> <li>Kafka - Message broker</li> <li>GraphQL Gateway - Internal API for data mutations</li> <li>Stripe - Payment and product management</li> <li>Twilio - SMS delivery</li> <li>Localization API - Text translation</li> </ul>"},{"location":"services/kafka-consumer/#local-development","title":"Local Development","text":""},{"location":"services/kafka-consumer/#running-a-specific-consumer","title":"Running a Specific Consumer","text":"<pre><code>cd dotnet/KafkaConsumer\ndotnet run -- clients\n</code></pre>"},{"location":"services/kafka-consumer/#debug-profiles","title":"Debug Profiles","text":"<p>The <code>launchSettings.json</code> contains profiles for each topic, allowing easy debugging in your IDE:</p> <ul> <li><code>KafkaConsumer (Notifications)</code></li> <li><code>KafkaConsumer (Plans)</code></li> <li><code>KafkaConsumer (Clients)</code></li> <li>etc.</li> </ul>"},{"location":"services/kafka-consumer/#development-vs-production-mode","title":"Development vs Production Mode","text":"<p>In development, SMS notifications are logged to the console instead of being sent via Twilio. This is controlled by the <code>LocalNotifier</code> vs <code>TwilioNotifier</code> service registration.</p>"},{"location":"services/kafka-consumer/#error-handling","title":"Error Handling","text":"<p>The service uses several error handling strategies:</p> <ol> <li>Result Monads - Business logic returns <code>Result&lt;T, Exception&gt;</code> for type-safe error handling</li> <li>Retry Policies - Polly-based retries for transient failures (e.g., Stripe API)</li> <li>Circuit Breaker - Prevents cascading failures when external services are down</li> <li>Dead Letter Queue - Unprocessable messages can be routed to a DLQ topic</li> </ol>"},{"location":"services/kafka-consumer/#observability","title":"Observability","text":"<ul> <li>OpenTelemetry Tracing - Distributed traces across service boundaries</li> <li>Structured Logging - Contextual logs with message IDs and correlation</li> <li>Prometheus Metrics - Exposed via Kestrel endpoint for scraping</li> </ul>"},{"location":"services/localization-api/","title":"LocalizationApi","text":"<p>LocalizationApi is a gRPC-based string localization service for translating and formatting user-facing messages, primarily for SMS communications.</p>"},{"location":"services/localization-api/#supported-locales","title":"Supported Locales","text":"<ul> <li><code>en-US</code> - English (default)</li> <li><code>es-ES</code> - Spanish</li> </ul>"},{"location":"services/localization-api/#grpc-api","title":"gRPC API","text":"<pre><code>service LocalizationService {\n    rpc GetLocalizedString(LocalizationRequest) returns (LocalizationResponse);\n}\n\nmessage LocalizationRequest {\n    string resourceKey = 1;\n    string locale = 2;\n    map&lt;string, string&gt; parameters = 3;\n}\n</code></pre>"},{"location":"services/localization-api/#usage","title":"Usage","text":"<p>Request a localized string with parameter substitution:</p> <pre><code>var response = await client.GetLocalizedStringAsync(new LocalizationRequest {\n    ResourceKey = \"AnnouncementSent\",\n    Locale = \"es-ES\",\n    Parameters = { { \"count\", \"5\" } }\n});\n// Returns: \"Anuncio enviado a 5 suscriptores\"\n</code></pre>"},{"location":"services/localization-api/#resource-keys","title":"Resource Keys","text":"<p>Strings are stored in .NET resource files (<code>LocalizationService.resx</code>, <code>LocalizationService.es.resx</code>).</p> <p>Example keys: - <code>AnnouncementSent</code> - Confirmation after sending announcement - <code>ClientHelpMessage</code> - Help text for SMS commands - <code>NotSubscriber</code> - Error when user isn't subscribed - <code>WelcomeMessage</code> - Welcome SMS for new subscribers</p> <p>Parameters use <code>{paramName}</code> syntax for substitution.</p>"},{"location":"services/localization-api/#configuration","title":"Configuration","text":"<pre><code>Kestrel__Endpoints__gRPC__Url=http://*:8888\nOtlp__Endpoint=http://otel-collector:4317\n</code></pre>"},{"location":"services/localization-api/#running","title":"Running","text":"<pre><code>cd dotnet/LocalizationApi\ndotnet run\n</code></pre> <p>Default port: <code>8888</code> (gRPC/HTTP2)</p>"},{"location":"services/localization-api/#notes","title":"Notes","text":"<ul> <li>Built with NativeAOT for fast startup</li> <li>Includes ICU libraries for proper locale support</li> </ul>"},{"location":"services/payment-api/","title":"PaymentApi","text":"<p>PaymentApi is a GraphQL subgraph that manages checkout sessions and payment confirmations via Stripe integration.</p>"},{"location":"services/payment-api/#entities","title":"Entities","text":"Entity Description MerchantService Payment provider configuration PaymentConfirmation Record of completed payment CheckoutSession Stripe checkout session info"},{"location":"services/payment-api/#graphql-operations","title":"GraphQL Operations","text":""},{"location":"services/payment-api/#queries","title":"Queries","text":"Query Auth Description <code>getMerchantService(id)</code> Admin Get merchant service <code>getMerchantServices()</code> Admin List merchant services <code>getPaymentConfirmation(id)</code> Admin Get payment confirmation <code>getPaymentConfirmationByCode(code)</code> Admin Lookup by confirmation code"},{"location":"services/payment-api/#mutations","title":"Mutations","text":"Mutation Auth Description <code>createCheckoutSession(input)</code> Client Create Stripe checkout session <code>cancelCheckoutSession(input)</code> Client Cancel checkout session <code>createPaymentConfirmation(input)</code> Admin Record payment confirmation"},{"location":"services/payment-api/#createcheckoutsession-input","title":"createCheckoutSession Input","text":"<pre><code>input CreateCheckoutSessionInput {\n  customerId: String!\n  priceForeignServiceId: String!  # Stripe price ID\n  successUrl: String!\n  cancelUrl: String!\n}\n</code></pre> <p>Returns checkout URL for redirect to Stripe.</p>"},{"location":"services/payment-api/#configuration","title":"Configuration","text":"<pre><code>ConnectionStrings__PaymentDb=Host=localhost;Database=paymentdb;...\nSTRIPE_API_KEY=sk_...\nSTRIPE_API_URL=https://api.stripe.com\nKafka__BrokerList=kafka:9092\nREDIS_URL=redis:6379\nOtlp__Endpoint=http://otel-collector:4317\n</code></pre>"},{"location":"services/payment-api/#kafka-events","title":"Kafka Events","text":"<p>Publishes to topics: <code>payments</code>, <code>notifications</code></p>"},{"location":"services/payment-api/#running","title":"Running","text":"<pre><code>cd dotnet/PaymentApi\ndotnet run\n</code></pre> <p>Default port: <code>5400</code></p>"},{"location":"services/product-api/","title":"ProductApi","text":"<p>ProductApi is a GraphQL subgraph that manages subscription plans, pricing tiers, and discount codes.</p>"},{"location":"services/product-api/#entities","title":"Entities","text":"Entity Description Plan Subscription plan with name, description, features, icon PriceTier Pricing option for a plan (price, duration, status) PlanSubscription Client's subscription to a plan DiscountCode Promotional discount codes"},{"location":"services/product-api/#graphql-operations","title":"GraphQL Operations","text":""},{"location":"services/product-api/#queries","title":"Queries","text":"Query Auth Description <code>getPlan(id)</code> Any Fetch plan by ID <code>getPlans(duration)</code> Any List plans, optionally filtered <code>getPlanByForeignId(id)</code> Admin Lookup by Stripe product ID <code>getPriceTier(id)</code> Any Get price tier <code>getPriceTierByForeignId(id)</code> Admin Lookup by Stripe price ID <code>getPlanSubscription(id)</code> Any Get subscription <code>getPlanSubscriptions()</code> Any List subscriptions <code>getDiscountCode(id)</code> Admin Get discount code <code>getDiscountCodes()</code> Admin List discount codes"},{"location":"services/product-api/#mutations","title":"Mutations","text":"Mutation Auth Description <code>createPlan(input)</code> Admin Create plan with tiers and features <code>updatePlan(input)</code> Admin Full update of plan <code>patchPlan(input)</code> Admin Partial update <code>deletePlan(id)</code> Admin Delete plan <code>patchPriceTier(input)</code> Admin Update price tier <code>deletePriceTier(id)</code> Admin Deactivate price tier <code>subscribeToPlan(input)</code> Client Subscribe to a plan <code>endSubscription(id)</code> Client End subscription <code>createPlanSubscription(input)</code> Admin Create subscription for client <code>createDiscountCode(input)</code> Admin Create discount code <code>patchDiscountCode(input)</code> Admin Update discount code <code>deleteDiscountCode(id)</code> Admin Delete discount code"},{"location":"services/product-api/#subscriptions-websocket","title":"Subscriptions (WebSocket)","text":"<ul> <li><code>onPlanUpdated(id)</code> - Real-time plan updates</li> <li><code>onPriceTierUpdated(id)</code> - Real-time price tier updates</li> </ul>"},{"location":"services/product-api/#configuration","title":"Configuration","text":"<pre><code>ConnectionStrings__ProductDb=Host=localhost;Database=productdb;...\nKafka__BrokerList=kafka:9092\nREDIS_URL=redis:6379\nOtlp__Endpoint=http://otel-collector:4317\n</code></pre>"},{"location":"services/product-api/#kafka-events","title":"Kafka Events","text":"<p>Publishes to topics: <code>plans</code>, <code>priceTiers</code>, <code>planSubscriptions</code>, <code>discountCodes</code>, <code>notifications</code></p>"},{"location":"services/product-api/#running","title":"Running","text":"<pre><code>cd dotnet/ProductApi\ndotnet run\n</code></pre> <p>Default port: <code>5200</code></p>"},{"location":"services/user-api/","title":"UserApi","text":"<p>UserApi is a GraphQL subgraph that manages users, clients, and subscribers.</p>"},{"location":"services/user-api/#entities","title":"Entities","text":"Entity Description Admin System administrators Client Service providers/businesses with subscribers Subscriber End-users who subscribe to clients User Underlying user record (phone, locale, subject)"},{"location":"services/user-api/#graphql-operations","title":"GraphQL Operations","text":""},{"location":"services/user-api/#queries","title":"Queries","text":"Query Auth Description <code>getClient(id)</code> Admin Fetch client by ID <code>getClientByPhoneNumber(phone)</code> Admin Lookup by phone hash <code>getClientBySlug(slug)</code> Any Public lookup by slug <code>getClientByCustomerId(id)</code> Admin Find by Stripe customer ID <code>getClients()</code> Admin List all clients <code>getSubscribers()</code> Admin/Client List subscribers <code>totalClients()</code> Admin Count clients <code>totalSubscribers()</code> Admin Count subscribers <code>viewer</code> Any Current authenticated user"},{"location":"services/user-api/#mutations","title":"Mutations","text":"Mutation Auth Description <code>createClient(input)</code> Client Create client from authenticated user <code>updateClient(input)</code> Admin/Client Update client details <code>deleteClient(id)</code> Admin Remove client <code>subscribeToClient(clientId)</code> Subscriber Join client's subscriber list <code>unsubscribeFromClient(clientId)</code> Subscriber Leave client <code>deleteSubscriber(id)</code> Admin Remove subscriber"},{"location":"services/user-api/#subscriptions-websocket","title":"Subscriptions (WebSocket)","text":"<ul> <li><code>onClientUpdated(id)</code> - Real-time client updates</li> <li><code>clientCreated</code> - New client created</li> <li><code>subscriberUnsubscribed</code> - Subscriber left</li> </ul>"},{"location":"services/user-api/#configuration","title":"Configuration","text":"<pre><code>ConnectionStrings__UserDb=Host=localhost;Database=userdb;...\nHashSettings__HashKeyBase64=&lt;base64-key&gt;\nEncryptionSettings__Key=&lt;base64-key&gt;\nKafka__BrokerList=kafka:9092\nREDIS_URL=redis:6379\nOtlp__Endpoint=http://otel-collector:4317\n</code></pre>"},{"location":"services/user-api/#security","title":"Security","text":"<ul> <li>Phone numbers are hashed (HMAC) for lookups</li> <li>Sensitive fields use AES-GCM encryption</li> <li>JWT authentication via Keycloak</li> </ul>"},{"location":"services/user-api/#kafka-events","title":"Kafka Events","text":"<p>Publishes to topics: <code>clients</code>, <code>notifications</code></p>"},{"location":"services/user-api/#running","title":"Running","text":"<pre><code>cd dotnet/UserApi\ndotnet run\n</code></pre> <p>Default port: <code>5300</code></p>"},{"location":"services/warpcache/","title":"WarpCache","text":"<p>WarpCache is a high-performance, async in-memory caching service with a gRPC interface. It's used throughout Nudges for token storage, session data, and temporary state.</p>"},{"location":"services/warpcache/#architecture","title":"Architecture","text":"Component Purpose <code>Precision.WarpCache</code> Core library with channel-based async operations <code>Precision.WarpCache.MemoryCache</code> In-memory backend using .NET MemoryCache <code>Precision.WarpCache.Redis</code> Distributed Redis backend <code>Precision.WarpCache.Grpc</code> gRPC server exposing cache operations <code>Precision.WarpCache.Grpc.Client</code> Strongly-typed gRPC client"},{"location":"services/warpcache/#grpc-api","title":"gRPC API","text":"<pre><code>service CacheGrpcService {\n    rpc Get (CacheRequest) returns (CacheResponse);\n    rpc Set (CacheRequest) returns (CacheResponse);\n    rpc Remove (CacheRequest) returns (CacheResponse);\n}\n</code></pre>"},{"location":"services/warpcache/#client-usage","title":"Client Usage","text":"<pre><code>// Register in DI\nservices.AddWarpCacheClient&lt;MyType&gt;(settings, MyTypeSerializerContext.Default.MyType);\n\n// Use\nvar value = await cacheClient.GetAsync(\"key\");\nawait cacheClient.SetAsync(\"key\", value, TimeSpan.FromMinutes(5));\nawait cacheClient.RemoveAsync(\"key\");\n</code></pre>"},{"location":"services/warpcache/#features","title":"Features","text":"<ul> <li>Async channel-based architecture - Lock-free operation queueing</li> <li>LRU eviction - Automatic eviction when capacity exceeded (default 1000 items)</li> <li>TTL support - Expiration with Unix timestamp tracking</li> <li>Pluggable backends - In-memory or Redis</li> </ul>"},{"location":"services/warpcache/#configuration","title":"Configuration","text":"<pre><code>Kestrel__Endpoints__gRPC__Url=http://*:7777\nKestrel__EndpointDefaults__Protocols=Http2\nOtlp__Endpoint=http://otel-collector:4317\n</code></pre>"},{"location":"services/warpcache/#running","title":"Running","text":"<pre><code>cd dotnet/Precision.WarpCache.Server\ndotnet run\n</code></pre> <p>Default port: <code>7777</code> (gRPC/HTTP2)</p>"},{"location":"services/webhooks/","title":"Webhooks","text":"<p>The Webhooks service handles incoming webhooks from Stripe (payments) and Twilio (SMS), processing external events and synchronizing data with the Nudges system.</p>"},{"location":"services/webhooks/#endpoints","title":"Endpoints","text":"Endpoint Method Purpose <code>/api/StripeWebhookHandler?code={key}</code> POST Stripe webhook events <code>/api/TwilioWebhookHandler?code={key}</code> POST Incoming SMS from Twilio <p>Both endpoints require the <code>WEBHOOKS_API_KEY</code> as a query parameter.</p>"},{"location":"services/webhooks/#stripe-webhooks","title":"Stripe Webhooks","text":""},{"location":"services/webhooks/#handled-events","title":"Handled Events","text":"Event Action <code>checkout.session.completed</code> Creates payment confirmation and plan subscription <code>product.created</code> Syncs new Stripe product to Nudges plan <code>product.updated</code> Updates plan name, description, icon, active status <code>product.deleted</code> Deletes corresponding plan <code>price.created</code> Creates price tier from Stripe price <code>price.updated</code> Updates price tier amount <code>price.deleted</code> Deletes price tier"},{"location":"services/webhooks/#event-flow","title":"Event Flow","text":"<pre><code>sequenceDiagram\n    participant Stripe\n    participant Webhooks\n    participant GraphQL as GraphQL API\n    participant Kafka\n\n    Stripe-&gt;&gt;Webhooks: POST /api/StripeWebhookHandler\n    Note over Webhooks: Verify signature\n    Webhooks-&gt;&gt;GraphQL: Query/Mutate data\n    Webhooks-&gt;&gt;Kafka: Publish event\n    Webhooks--&gt;&gt;Stripe: 200 OK</code></pre>"},{"location":"services/webhooks/#checkout-flow","title":"Checkout Flow","text":"<p>When <code>checkout.session.completed</code> fires:</p> <ol> <li>Retrieves invoice and session details from Stripe</li> <li>Looks up client by Stripe customer ID</li> <li>Creates <code>PaymentConfirmation</code> record</li> <li>Creates <code>PlanSubscription</code> linking client to plan</li> </ol>"},{"location":"services/webhooks/#twilio-webhooks","title":"Twilio Webhooks","text":""},{"location":"services/webhooks/#sms-commands","title":"SMS Commands","text":"<p>Users can text commands to interact with the system:</p> Command Pattern Action <code>COMMANDS</code> or <code>HELP</code> <code>^commands$</code> / <code>^help$</code> Returns help text with links <code>UNSUB &lt;n&gt;</code> <code>UNSUB (\\d+)</code> Unsubscribe from client by number <code>CONFIRM</code> <code>^CONFIRM$</code> Confirms pending announcement (any text) <code>.*</code> Drafts announcement, prompts for confirm"},{"location":"services/webhooks/#announcement-flow","title":"Announcement Flow","text":"<ol> <li>User (client) texts message content</li> <li>System stores draft in cache: <code>announcement:{phone}</code></li> <li>User texts <code>CONFIRM</code></li> <li>System sends to all subscribers, returns count</li> </ol>"},{"location":"services/webhooks/#ignored-messages","title":"Ignored Messages","text":"<p>These Twilio opt-in keywords are acknowledged but not processed: - <code>stop</code>, <code>start</code>, <code>unstop</code>, <code>help</code></p>"},{"location":"services/webhooks/#configuration","title":"Configuration","text":"<pre><code># API Security\nWEBHOOKS_API_KEY=&lt;api-key&gt;\n\n# Stripe\nSTRIPE_API_KEY=sk_...\nSTRIPE_WEBHOOKS_SECRET=whsec_...\n\n# Twilio\nTWILIO_ACCOUNT_SID=AC...\nTWILIO_AUTH_TOKEN=&lt;token&gt;\nTWILIO_MESSAGE_SERVICE_SID=MG...\n\n# Internal Services\nGRAPHQL_API_URL=http://graphql-gateway:5443/graphql\nLOCALIZATION_API_URL=http://localization-api:5000\nAUTH_API_URL=http://auth-api:5555\n\n# Cache &amp; Messaging\nREDIS_URL=redis:6379\nWarpCache__Url=http://warpcache:7777\nKafka__BrokerList=kafka:9092\n\n# URLs for SMS responses\nAccountUrl=https://app.example.com/account\nStripePortalUrl=https://billing.stripe.com/p/...\nClientLinkBaseUri=https://app.example.com\n\n# OIDC (for GraphQL auth)\nOidc__ServerUrl=https://keycloak.example.com\nOidc__Realm=nudges\nOidc__ClientId=webhooks\nOidc__ClientSecret=&lt;secret&gt;\n</code></pre>"},{"location":"services/webhooks/#kafka-events-produced","title":"Kafka Events Produced","text":"Topic Events <code>Payments</code> Payment confirmation events <code>Notifications</code> SMS notification events <code>ForeignProducts</code> Stripe product sync events"},{"location":"services/webhooks/#running","title":"Running","text":""},{"location":"services/webhooks/#local-development","title":"Local Development","text":"<pre><code>cd dotnet/Nudges.Webhooks\ndotnet run\n</code></pre>"},{"location":"services/webhooks/#docker","title":"Docker","text":"<pre><code>docker build -f dotnet/Nudges.Webhooks.Dockerfile -t webhooks .\ndocker run --env-file .env -p 5000:5000 webhooks\n</code></pre>"},{"location":"services/webhooks/#testing-webhooks-locally","title":"Testing Webhooks Locally","text":"<p>Use the Stripe CLI to forward webhooks:</p> <pre><code>stripe listen --forward-to localhost:5000/api/StripeWebhookHandler?code=your-key\n</code></pre> <p>For Twilio, use ngrok or similar to expose your local endpoint.</p>"}]}